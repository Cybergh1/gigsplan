rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // ðŸ”’ HELPER FUNCTIONS
    // =========================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the document owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is admin (multiple role formats supported)
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin');
    }

    // Check if user is super agent
    function isSuperAgent() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_agent';
    }

    // Check if user is agent or super agent
    function isAgent() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Agent', 'super_agent'];
    }

    // Check if balance is being reduced (purchases)
    function isBalanceDecreasing() {
      return request.resource.data.balance < resource.data.balance;
    }

    // =========================================================================
    // ðŸ—‚ï¸ USERS COLLECTION
    // =========================================================================

    match /users/{userId} {
      // Users can read their own profile (needed for admin check)
      allow read: if isAuthenticated() && isOwner(userId);
      // Admins can read ALL users
      allow read, list: if isAdmin();

      // Create on signup
      allow create: if isAuthenticated() && isOwner(userId);

      // Admins can update anything
      allow update: if isAdmin();
      // Users can update their own (with balance restrictions)
      allow update: if isOwner(userId) && (
        isBalanceDecreasing() ||
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['balance', 'role', 'apiAccessEnabled', 'isGoldenActivated'])
      );

      // Admins can delete
      allow delete: if isAdmin();

      // User notifications subcollection
      match /notifications/{notificationId} {
        // Users can read their own notifications
        allow read, list: if isAuthenticated() && isOwner(userId);
        // Admins can create notifications for any user
        allow create: if isAdmin();
        // Users can update their own notifications (mark as read)
        allow update: if isAuthenticated() && isOwner(userId);
        // Users can delete their own notifications
        allow delete: if isAuthenticated() && isOwner(userId);
      }
    }

    // =========================================================================
    // ðŸ“¦ DATA PACKAGES (with subcollections)
    // =========================================================================

    // Parent collection
    match /dataPackages/{network} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Subcollection
    match /dataPackages/{network}/packages/{packageId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin();
    }

    // =========================================================================
    // ðŸ“± MTN JUST4U PACKAGES
    // =========================================================================

    match /mtnJust4UPackages/{packageId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin();
    }

    // =========================================================================
    // ðŸ›’ ORDERS COLLECTION
    // =========================================================================

    match /orders/{orderId} {
      // Admins can list ALL orders
      allow read, list: if isAdmin();
      // Users can read their own orders
      allow read: if isAuthenticated() && isOwner(resource.data.userId);

      // Users can create orders
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);

      // Admins can update
      allow update: if isAdmin();

      // No deletions
      allow delete: if false;
    }

    // =========================================================================
    // ðŸª STORE ORDERS
    // =========================================================================

    match /storeOrders/{orderId} {
      // Public read for QR verification
      allow read, list: if true;

      // Anyone can create
      allow create: if true;

      // Admins and merchants can update
      allow update: if isAdmin() || (isAuthenticated() && isOwner(resource.data.merchantId));

      allow delete: if false;
    }

    // =========================================================================
    // ðŸ’° TOP-UPS
    // =========================================================================

    match /topups/{topupId} {
      // Admins can read ALL
      allow read, list: if isAdmin();
      // Users can read their own
      allow read: if isAuthenticated() && isOwner(resource.data.userId);

      // Anyone authenticated can create (for webhooks)
      allow create: if isAuthenticated();

      // Admins can update
      allow update: if isAdmin();

      allow delete: if false;
    }

    // =========================================================================
    // ðŸ’µ MANUAL TOP-UPS (LEGACY - Feature Disabled)
    // =========================================================================

    match /manualTopups/{topupId} {
      // Admins can read ALL (for historical records)
      allow read, list: if isAdmin();
      // Users can read their own
      allow read: if isAuthenticated() && isOwner(resource.data.userId);

      // Disabled: No new manual top-ups can be created
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // =========================================================================
    // ðŸ’¸ PAYOUT REQUESTS
    // =========================================================================

    match /payoutRequests/{payoutId} {
      // Admins can read ALL
      allow read, list: if isAdmin();
      // Merchants can read their own
      allow read: if isAuthenticated() && isOwner(resource.data.merchantId);

      // Merchants can create
      allow create: if isAuthenticated() && isOwner(request.resource.data.merchantId);

      // Admins can update
      allow update: if isAdmin();

      allow delete: if false;
    }

    // Legacy payouts collection
    match /payouts/{payoutId} {
      allow read, list: if isAdmin();
      allow read: if isAuthenticated() && isOwner(resource.data.merchantId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.merchantId);
      allow update: if isAdmin();
      allow delete: if false;
    }

    // =========================================================================
    // ðŸ’³ TRANSACTIONS
    // =========================================================================

    match /transactions/{transactionId} {
      // Admins can read ALL
      allow read, list: if isAdmin();
      // Users can read their own
      allow read: if isAuthenticated() && isOwner(resource.data.userId);

      // Anyone authenticated can create
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);

      // Immutable
      allow update, delete: if false;
    }

    // =========================================================================
    // ðŸ‘¥ REFERRALS
    // =========================================================================

    match /referrals/{referralId} {
      // Admins can read ALL
      allow read, list: if isAdmin();
      // Users can read their own
      allow read: if isAuthenticated() && (
        isOwner(resource.data.referrerId) ||
        isOwner(resource.data.referredUserId)
      );

      // Authenticated users can create
      allow create: if isAuthenticated();

      // Admins can update
      allow update: if isAdmin();

      allow delete: if false;
    }

    // =========================================================================
    // ðŸŽŸï¸ RESULTS CHECKER ITEMS (with subcollections)
    // =========================================================================

    // Parent collection
    match /resultsCheckerItems/{checkerType} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Subcollection
    match /resultsCheckerItems/{checkerType}/items/{itemId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin();
    }

    // =========================================================================
    // ðŸ“ AFA REGISTRATIONS
    // =========================================================================

    match /afaRegistrations/{registrationId} {
      // Admins can read ALL registrations
      allow read, list: if isAdmin();
      // Users can read their own registrations
      allow read: if isAuthenticated() && isOwner(resource.data.userId);

      // Users can create their own registrations
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);

      // Admins can update registrations
      allow update: if isAdmin();

      // No deletions
      allow delete: if false;
    }

    // =========================================================================
    // ðŸ” 2FA CODES
    // =========================================================================

    match /twoFactorCodes/{codeId} {
      allow read, list: if isAdmin();
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated();
      allow update: if isAdmin() || (isAuthenticated() && isOwner(resource.data.userId));
      allow delete: if isAdmin();
    }

    // =========================================================================
    // ðŸ”‘ API KEYS
    // =========================================================================

    match /apiKeys/{keyId} {
      allow read, list: if isAdmin();
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAdmin() || (isAuthenticated() && isOwner(resource.data.userId));
      allow delete: if isAdmin() || (isAuthenticated() && isOwner(resource.data.userId));
    }

    // =========================================================================
    // ðŸ“Š API USAGE STATS
    // =========================================================================

    match /apiUsageStats/{statId} {
      allow read, list: if isAdmin();
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated();
      allow update: if isAdmin() || (isAuthenticated() && isOwner(resource.data.userId));
      allow delete: if isAdmin();
    }

    // =========================================================================
    // âš™ï¸ SITE SETTINGS (ADMIN FULL ACCESS)
    // =========================================================================

    match /siteSettings/{settingId} {
      // Everyone authenticated can read settings
      allow read, list: if isAuthenticated();

      // Admins can write/update/delete settings
      allow write: if isAdmin();
    }

    // =========================================================================
    // ðŸ”§ CONFIG COLLECTION (Site Configuration)
    // =========================================================================

    match /config/{docId} {
      // All authenticated users can read config documents
      allow read: if isAuthenticated();

      // Only admins can write/update config
      allow write: if isAdmin();
    }

    // =========================================================================
    // âš™ï¸ SETTINGS COLLECTION (Global Settings)
    // =========================================================================

    match /settings/{docId} {
      // All authenticated users can read settings
      allow read: if isAuthenticated();

      // Only admins can write/update settings
      allow write: if isAdmin();
    }

    // =========================================================================
    // ðŸ“Š ANALYTICS
    // =========================================================================

    match /analytics/{docId} {
      allow read, list: if isAdmin();
      allow write: if isAdmin();
    }

    // =========================================================================
    // ðŸ”” NOTIFICATIONS (FULL READ/WRITE FOR ALL AUTHENTICATED)
    // =========================================================================

    match /notifications/{notificationId} {
      // All authenticated users can read, list, create, update, delete
      allow read, list, create, update, delete: if isAuthenticated();
    }

    // Sent notifications log
    match /sent_notifications/{notificationId} {
      // All authenticated users can read
      allow read, list: if isAuthenticated();
      // Authenticated users can create (for logging)
      allow create: if isAuthenticated();
      // Admins can update/delete
      allow update, delete: if isAdmin();
    }

    // =========================================================================
    // ðŸ”” ADMIN NOTIFICATIONS
    // =========================================================================

    match /adminNotifications/{notificationId} {
      allow read, list: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // =========================================================================
    // ðŸŽ« GOLDEN TICKETS
    // =========================================================================

    match /goldenTickets/{ticketId} {
      allow read, list: if isAdmin();
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAdmin() || (isAuthenticated() && isOwner(resource.data.userId));
      allow delete: if isAdmin();
    }

    // =========================================================================
    // ðŸ›¡ï¸ SECURITY LOGS (Admin only)
    // =========================================================================

    match /securityLogs/{logId} {
      allow read, list: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // =========================================================================
    // ðŸ“ˆ RATE LIMITS (Admin only)
    // =========================================================================

    match /rateLimits/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow write: if isAdmin();
    }

    // =========================================================================
    // ðŸ’¼ MERCHANT STORES
    // =========================================================================

    match /stores/{storeId} {
      // Public read for store pages
      allow read, list: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    match /merchantStores/{merchantId} {
      // Public read for store pages
      allow read, list: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // =========================================================================
    // ðŸ‘¥ STORE CUSTOMERS
    // =========================================================================

    match /storeCustomers/{customerId} {
      // Admins can read ALL
      allow read, list: if isAdmin();
      // Merchants can read their own
      allow read: if isAuthenticated() && isOwner(resource.data.merchantId);
      // General authenticated read for lookup
      allow read: if isAuthenticated();

      allow create: if isAuthenticated();
      allow update: if isAdmin() || (isAuthenticated() && isOwner(resource.data.merchantId));
      allow delete: if isAdmin();
    }

    // =========================================================================
    // ðŸ“± SMS LOGS (Admin only)
    // =========================================================================

    match /smsLogs/{logId} {
      allow read, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // =========================================================================
    // ðŸŽ›ï¸ CONTROL/ADMIN CONTROLS (FULL READ/WRITE FOR AUTHENTICATED)
    // =========================================================================

    match /control/{docId} {
      // Full access for all authenticated users
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /controls/{docId} {
      // Full access for all authenticated users
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /adminControls/{docId} {
      // Full access for all authenticated users
      allow read, list, create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // ðŸš« DEFAULT DENY ALL OTHER PATHS
    // =========================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
