
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Admin Panel - QuickXpress</title>
    <!-- Favicon -->
    <link rel="icon" href="https://dev-dataverse-global.pantheonsite.io/wp-content/uploads/2025/08/IMG-20250807-WA0024-2.jpg" type="image/png">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 for Professional Popups -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        :root {
            --admin-primary-green: #27ae60;
            --admin-primary-green-light: #2ecc71;
            --admin-sidebar-bg: #ffffff;
            --admin-body-bg: #f4f6f8;
            --admin-card-bg: #ffffff;
            --admin-text-primary: #34495e;
            --admin-text-secondary: #7f8c8d;
            --admin-border-color: #e0e0e0;
            --admin-input-bg: #ffffff;
            --admin-input-border: #ced4da;
            --admin-accent-active: var(--admin-primary-green);
            --admin-accent-hover: #229954;
            --admin-danger: #e74c3c;
            --admin-success: var(--admin-primary-green);
            --admin-warning: #f39c12;
            --admin-info: #3498db;
            --table-header-bg: #f8f9fa;
            --table-header-text: #495057;
            --table-row-hover-bg: #e9ecef;
            --admin-sidebar-width: 250px;
            --professional-border-radius: 8px;
            --professional-shadow: 0 4px 12px rgba(0,0,0,0.07);
            --status-completed-bg-light: #e8f5e9;
            --status-completed-text-dark: #27ae60;
            --status-pending-bg-light: #fff8e1;
            --status-pending-text-dark: #f39c12;
            --status-processing-bg-light: #e0f2fe; /* NEW */
            --status-processing-text-dark: #3498db; /* NEW */
            --status-failed-bg-light: #ffebee;
            --status-failed-text-dark: #e74c3c;
            --status-rejected-bg-light: #fbe9e7;
            --status-rejected-text-dark: #d84315;
            --status-queued-bg-light: #f3e5f5;
            --status-queued-text-dark: #8e44ad;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-weight: normal; }
        html, body { height: 100%; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--admin-body-bg);
            color: var(--admin-text-primary);
            overflow-x: hidden;
            font-size: 13px;
        }
        
        /* --- Login Page Styles --- */
        .admin-login-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 380px;
            text-align: center;
        }
        .login-card h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .login-card p {
            color: var(--admin-text-secondary);
            margin-bottom: 25px;
        }
        .login-card .form-group {
            text-align: left;
        }
        .login-card .form-submit-button {
            width: 100%;
        }

        .admin-panel-container { 
            display: none; 
            width: 100%; 
            height: 100vh; 
            position: relative; 
        }

        .admin-sidebar {
            width: var(--admin-sidebar-width); background-color: var(--admin-sidebar-bg);
            color: var(--admin-text-primary); padding: 0; display: flex; flex-direction: column;
            position: fixed; height: 100%; left: 0; top: 0; z-index: 1001;
            box-shadow: 2px 0 12px rgba(0,0,0,0.1);
            transform: translateX(calc(-1 * var(--admin-sidebar-width)));
            transition: transform 0.3s cubic-bezier(0.645, 0.045, 0.355, 1);
            overflow-y: auto;
        }
        .admin-sidebar.active { transform: translateX(0); }
        .admin-sidebar-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4); z-index: 1000;
        }
        .admin-sidebar-overlay.active { display: block; }

        .admin-sidebar-header {
            display: flex; align-items: center; padding: 18px;
            border-bottom: 1px solid var(--admin-border-color); margin-bottom: 8px;
        }
        .admin-logo-placeholder { margin-right: 12px; }
        .admin-logo-placeholder img { height: 36px; width: 36px; border-radius: 8px; }
        .admin-sidebar-header .admin-panel-title-text {
            font-size: 20px; font-weight: 700; color: var(--admin-text-primary); margin:0;
        }
        .admin-sidebar-subheader {
            font-size: 11px; color: var(--admin-text-secondary); text-transform: uppercase;
            letter-spacing: 0.8px; margin: 15px 18px 8px; font-weight: 600;
        }
        .admin-sidebar-menu ul { list-style: none; }
        .admin-sidebar-menu li a {
            display: flex; align-items: center; padding: 12px 18px; margin: 0 10px 4px 10px;
            color: var(--admin-text-secondary); border-radius: 6px; text-decoration: none;
            position: relative; transition: background-color 0.25s ease, color 0.25s ease;
            font-size: 13px; font-weight: 400;
        }
        .admin-sidebar-menu li a:hover { background-color: #e9ecef; color: var(--admin-text-primary); }
        .admin-sidebar-menu li a.active {
            background-color: var(--admin-accent-active); color: white; font-weight: 500;
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.25);
        }
        .admin-sidebar-menu li a i {
            margin-right: 16px; width: 18px; text-align: center; font-size: 14px;
            color: inherit;
        }
        
        .admin-main-content-wrapper {
            width: 100%; height: 100vh; overflow-y: auto; padding-left: 0;
            transition: padding-left 0.3s cubic-bezier(0.645, 0.045, 0.355, 1);
        }
        @media (min-width: 769px) {
            body.admin-sidebar-open .admin-main-content-wrapper { padding-left: var(--admin-sidebar-width); }
        }

        .admin-top-bar {
            background-color: var(--admin-card-bg); padding: 0 18px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--admin-border-color);
            position: sticky; top: 0; z-index: 900; height: 60px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        }
        .admin-menu-toggle {
            font-size: 18px; color: var(--admin-text-primary); cursor: pointer;
            background: none; border: none; padding: 8px;
        }
        .admin-top-bar-title { font-size: 18px; color: var(--admin-text-primary); font-weight: 600; }
        .admin-header-controls { display: flex; align-items: center; gap: 15px; }
        .admin-logout-btn {
            background-color: transparent; color: var(--admin-text-primary);
            border: 1px solid var(--admin-border-color); padding: 8px 15px;
            border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
            transition: all 0.2s;
        }
        .admin-logout-btn:hover { background-color: var(--admin-primary-green); border-color: var(--admin-primary-green); color: white; }
        .admin-logout-btn i { margin-right: 6px; }

        .admin-main-content { padding: 25px 18px; }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .admin-card {
            background-color: var(--admin-card-bg); padding: 20px 25px;
            border-radius: 10px; border: 1px solid var(--admin-border-color);
            margin-bottom: 20px; box-shadow: var(--professional-shadow);
        }
        .admin-card h3 {
            font-size: 17px; margin-bottom: 18px; padding-bottom: 12px;
            border-bottom: 1px solid var(--admin-border-color); font-weight: 600;
        }
        .admin-filters { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid var(--admin-border-color); }
        .admin-filters .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; align-items: end; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-size: 12px; margin-bottom: 6px; font-weight: 500; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 10px 12px; border: 1px solid var(--admin-input-border); border-radius: 6px;
            font-size: 13px; background-color: var(--admin-input-bg); color: var(--admin-text-primary);
            transition: all 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none; border-color: var(--admin-accent-active);
            box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
        }
        .form-submit-button {
            background-color: var(--admin-primary-green-light); color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-size: 13px; font-weight: 500; transition: all 0.2s;
            position: relative; min-height: 40px;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .form-submit-button:hover { background-color: var(--admin-accent-hover); transform: translateY(-1px); }
        .form-submit-button .btn-text { transition: opacity 0.1s ease; }
        .form-submit-button .spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 1.1em; height: 1.1em; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; display: none; }
        .form-submit-button.loading .btn-text { opacity: 0; } .form-submit-button.loading .spinner { display: inline-block; }
        .form-submit-button i { margin-right: 8px; }

        .admin-table-wrapper { overflow-x: auto; border: 1px solid var(--admin-border-color); border-radius: 8px; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 12.5px; }
        .admin-table th, .admin-table td {
            padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--admin-border-color);
            white-space: nowrap;
        }
        .admin-table th {
            background-color: var(--table-header-bg); color: var(--table-header-text);
            font-weight: 500; text-transform: uppercase; font-size: 11px;
        }
        .admin-table tbody tr:hover { background-color: var(--table-row-hover-bg); }
        .admin-table .action-btn {
            padding: 6px 10px; border-radius: 5px; font-size: 12px; font-weight: 500;
            cursor: pointer; border: none; margin: 0 3px; display: inline-flex; align-items: center;
            gap: 5px; transition: all 0.2s;
            color: white;
        }
        .admin-table .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .admin-table .action-btn.edit-btn { background-color: var(--admin-warning); color: var(--admin-text-primary); }
        .admin-table .action-btn.delete-btn, .admin-table .action-btn.reject-btn { background-color: var(--admin-danger); }
        .admin-table .action-btn.approve-btn, .admin-table .action-btn.view-btn { background-color: var(--admin-success); }
        
        .status-badge {
            padding: 5px 12px; border-radius: 16px; font-size: 11px; font-weight: 600;
            display: inline-flex; align-items: center; justify-content: center; text-align: center;
            min-width: 90px; border: 1px solid transparent; text-transform: capitalize;
        }
        .status-badge.completed, .status-badge.active, .status-badge.approved, .status-badge.paid { background-color: var(--status-completed-bg-light); color: var(--status-completed-text-dark); border-color: var(--status-completed-text-dark); }
        .status-badge.pending { background-color: var(--status-pending-bg-light); color: var(--status-pending-text-dark); border-color: var(--status-pending-text-dark); }
        .status-badge.processing { background-color: var(--status-processing-bg-light); color: var(--status-processing-text-dark); border-color: var(--status-processing-text-dark); }
        .status-badge.failed, .status-badge.cancelled, .status-badge.inactive, .status-badge.terminated, .status-badge.banned { background-color: var(--status-failed-bg-light); color: var(--status-failed-text-dark); border-color: var(--status-failed-text-dark); }
        .status-badge.rejected { background-color: var(--status-rejected-bg-light); color: var(--status-rejected-text-dark); border-color: var(--status-rejected-text-dark); }
        .status-badge.queued { background-color: var(--status-queued-bg-light); color: var(--status-queued-text-dark); border-color: var(--status-queued-text-dark); }
        
        .no-data-placeholder { text-align: center; padding: 30px 20px; background-color: #fdfdfd; border-radius: 8px; color: var(--admin-text-secondary); margin: 20px 0; border: 1px dashed var(--admin-border-color); }
        .no-data-placeholder .icon { font-size: 2.5em; margin-bottom: 10px; opacity: 0.4; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 5000; opacity: 0; visibility: hidden; transition: all 0.3s ease; padding: 15px;}
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--admin-card-bg); padding: 25px;
            border-radius: 10px; box-shadow: var(--professional-shadow);
            text-align: left; max-width: 600px; width: 100%; transform: scale(0.95);
            transition: all 0.3s ease; max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h3 {
            font-size: 17px; margin-bottom: 18px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--admin-border-color); padding-bottom: 12px; font-weight: 600;
        }
        .modal-content .close-modal-btn { font-size: 18px; cursor: pointer; color: var(--admin-text-secondary); transition: color 0.2s; background: none; border:none; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .modal-btn {
            padding: 8px 18px; border-radius: 6px; font-size: 13px; font-weight: 500;
            cursor: pointer; border: none; transition: all 0.2s;
        }
        .modal-btn:hover { transform: translateY(-1px); }
        .modal-btn.cancel { background-color: #f0f0f0; color: var(--admin-text-primary); border: 1px solid var(--admin-border-color); }
        .modal-btn.confirm { background-color: var(--admin-accent-active); color: white; }
        .modal-btn.danger { background-color: var(--admin-danger); color: white; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 20px; margin-bottom: 25px;}
        .stat-item {
            background-color: var(--admin-card-bg); padding: 20px; border-radius: 10px;
            display: flex; align-items: center; gap: 18px;
            box-shadow: var(--professional-shadow);
            transition: all 0.2s ease-out;
        }
        .stat-item:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
        .stat-item .stat-icon {
            font-size: 1.8em;
            width: 50px; height: 50px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
        }
        .stat-item.revenue .stat-icon { background-color: #e8f5e9; color: #27ae60; }
        .stat-item.users .stat-icon { background-color: #e3f2fd; color: #3498db; }
        .stat-item.orders .stat-icon { background-color: #f3e5f5; color: #8e44ad; }
        .stat-item.orders-today .stat-icon { background-color: #e0f7fa; color: #0097a7; }
        .stat-item.user-balance .stat-icon { background-color: #f0e6ff; color: #6f42c1; } 

        .admin-loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(244, 246, 248, 0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .admin-loader-overlay.active { opacity: 1; visibility: visible; }
        .loader-spinner { width: 40px; height: 40px; border: 4px solid rgba(39, 174, 96, 0.2); border-top-color: var(--admin-accent-active); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .switch { position: relative; display: inline-block; width: 46px; height: 24px; vertical-align: middle;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--admin-accent-active); }
        input:checked + .slider:before { transform: translateX(20px); }

        .info-text { font-size: 12px; color: var(--admin-text-secondary); margin-top: 5px; }
        .sub-section { margin-top: 20px; padding-top: 18px; border-top: 1px solid var(--admin-border-color); }
        .sub-section h5 { font-size: 1.05em; color: var(--admin-text-primary); margin-bottom: 12px; font-weight: 500; }
        
        .info-readonly-group { margin-bottom: 12px; }
        .info-readonly-group strong { display: block; font-size: 11px; font-weight: 600; color: #555; margin-bottom: 3px; text-transform: uppercase;}
        .info-readonly-group p { display: block; font-size: 13px; color: var(--admin-text-secondary); padding: 8px 10px; background-color: #f8f9fa; border-radius: 6px; border: 1px solid var(--admin-input-border); word-break: break-all;}
        
        .package-category-container {
            margin-bottom: 25px;
            border: 1px solid var(--admin-border-color);
            border-radius: 8px;
            background-color: #fff;
        }
        .package-category-header {
            font-size: 16px;
            font-weight: 600;
            padding: 15px;
            border-bottom: 1px solid var(--admin-border-color);
            background-color: #f8f9fa;
        }
        .package-category-header + .admin-table-wrapper {
            border: none;
            border-radius: 0 0 8px 8px;
        }

        /* [NEW] API Controls Specific Styles */
        .api-balance-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background-color: #f8f9fa; border-radius: 12px;
            border: 1px solid var(--admin-border-color); margin-bottom: 16px;
        }
        .balance-info .label { font-size: 13px; color: var(--admin-text-secondary); margin-bottom: 4px; }
        .balance-info .value { font-size: 24px; font-weight: 700; color: var(--admin-primary-green); }
        .balance-info .value.loading { font-size: 18px; color: var(--admin-text-secondary); }
        .balance-refresh-btn { background: none; border: none; cursor: pointer; color: var(--admin-info); }
        .balance-refresh-btn svg { width: 24px; height: 24px; }
        .balance-refresh-btn.loading svg { animation: spin 1s linear infinite; }
        
        .api-token-group { margin-top: 16px; }
        .api-token-group label { display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; }
        .api-token-group input { width: 100%; }
        .api-token-group button { width: 100%; margin-top: 10px; background-color: var(--admin-info);}
        .api-token-group button:hover { background-color: #2980b9; }

        /* Styles for dynamic lesson fields */
        .lesson-entry { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .lesson-entry .form-input { flex-grow: 1; }
        .lesson-entry .remove-lesson-btn { background-color: #ecf0f1; border: 1px solid #bdc3c7; color: #7f8c8d; cursor: pointer; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; }
        #add-lesson-field-btn { background-color: #e9ecef; border: 1px dashed #ced4da; color: #495057; }

    </style>
</head>
<body>
    <div class="admin-loader-overlay active" id="adminLoader"><div class="loader-spinner"></div></div>

    <div class="admin-login-wrapper" id="adminLoginWrapper">
        <div class="login-card">
            <h2>Admin Panel Login</h2>
            <p>Please sign in to continue.</p>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminLoginEmail">Email Address</label>
                    <input type="email" id="adminLoginEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="adminLoginPassword">Password</label>
                    <input type="password" id="adminLoginPassword" class="form-input" required>
                </div>
                <button type="submit" class="form-submit-button" id="adminLoginBtn">
                    <span class="btn-text">Login</span>
                    <span class="spinner"></span>
                </button>
            </form>
        </div>
    </div>

    <div class="admin-panel-container" id="adminPanelContainer">
        <div class="admin-sidebar-overlay" id="adminSidebarOverlay"></div>
        <nav class="admin-sidebar" id="adminSidebar">
            <div class="admin-sidebar-header">
                <div class="admin-logo-placeholder">
                    <img src="https://dev-dataverse-global.pantheonsite.io/wp-content/uploads/2025/08/IMG-20250807-WA0024-2.jpg" alt="Logo" id="adminSidebarLogo">
                </div>
                <h1 class="admin-panel-title-text" id="adminPanelTitleText">Admin</h1>
            </div>
            <p class="admin-sidebar-subheader">Main Navigation</p>
            <ul class="admin-sidebar-menu">
                <li><a href="#" class="admin-nav-link active" data-target="adminDashboardTab"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
                <li><a href="#" class="admin-nav-link" data-target="manageOrdersTab"><i class="fas fa-file-invoice-dollar"></i> Customer Orders</a></li>
                <li><a href="#" class="admin-nav-link" data-target="manageUsersTab"><i class="fas fa-users-cog"></i> Users</a></li>
                <!-- REMOVED: Manual Top Ups feature no longer used -->
                <!-- <li><a href="#" class="admin-nav-link" data-target="manualTopUpsTab"><i class="fas fa-hand-holding-usd"></i> Manual Top Ups</a></li> -->
                <li><a href="#" class="admin-nav-link" data-target="packageManagerTab"><i class="fas fa-boxes-stacked"></i> Data Packages</a></li>
                <li><a href="#" class="admin-nav-link" data-target="manageAfaRegistrationsTab"><i class="fas fa-id-card-alt"></i> AFA Registrations</a></li>
            </ul>

            <!-- Merchant Section -->
            <p class="admin-sidebar-subheader">Merchant Tools</p>
             <ul class="admin-sidebar-menu">
                <li><a href="#" class="admin-nav-link" data-target="storesTab"><i class="fas fa-store-alt"></i> Stores</a></li>
                <li><a href="#" class="admin-nav-link" data-target="storeOrdersTab"><i class="fas fa-store"></i> Store Orders</a></li>
                <li><a href="#" class="admin-nav-link" data-target="storePayoutsTab"><i class="fas fa-money-check-alt"></i> Store Payouts</a></li>
            </ul>

            <!-- Online Learning Section -->
            <p class="admin-sidebar-subheader">Online Learning</p>
            <ul class="admin-sidebar-menu">
                <li><a href="#" class="admin-nav-link" data-target="onlineCoursesTab"><i class="fas fa-book-open"></i> Online Courses</a></li>
                <li><a href="#" class="admin-nav-link" data-target="coursePurchasesTab"><i class="fas fa-history"></i> Course Purchases</a></li>
            </ul>

            <!-- Marketplace Section -->
            <p class="admin-sidebar-subheader">Marketplace</p>
            <ul class="admin-sidebar-menu">
                <li><a href="#" class="admin-nav-link" data-target="marketplaceBannersTab"><i class="fas fa-images"></i> Banners</a></li>
                <li><a href="#" class="admin-nav-link" data-target="marketplaceCategoriesTab"><i class="fas fa-tags"></i> Categories</a></li>
                <li><a href="#" class="admin-nav-link" data-target="marketplaceProductsTab"><i class="fas fa-shopping-bag"></i> Products</a></li>
                <li><a href="#" class="admin-nav-link" data-target="websiteQueueTab"><i class="fas fa-tasks"></i> Website Queue</a></li>
            </ul>

            <p class="admin-sidebar-subheader">Administration</p>
             <ul class="admin-sidebar-menu">
                <li><a href="#" class="admin-nav-link" data-target="notificationsTab"><i class="fas fa-bell"></i> Notifications</a></li>
                <li><a href="#" class="admin-nav-link" data-target="controlsTab"><i class="fas fa-sliders-h"></i> Controls</a></li>
            </ul>
        </nav>

        <div class="admin-main-content-wrapper" id="adminMainContentWrapper">
            <div class="admin-top-bar">
                <button class="admin-menu-toggle" id="adminMenuToggle"><i class="fas fa-bars"></i></button>
                <h1 class="admin-top-bar-title" id="adminPageTopBarTitle">Dashboard</h1>
                <div class="admin-header-controls">
                    <button class="admin-logout-btn" id="adminLogoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
            <main class="admin-main-content">
                <!-- Dashboard Tab -->
                <div id="adminDashboardTab" class="admin-tab-content active">
                    <div class="stats-grid">
                        <div class="stat-item revenue"><div class="stat-icon"><i class="fas fa-wallet"></i></div><div class="stat-info"><h4>Total Revenue</h4><p id="adminStatTotalRevenue">GH₵ 0.00</p></div></div>
                        <div class="stat-item users"><div class="stat-icon"><i class="fas fa-users"></i></div><div class="stat-info"><h4>Total Users</h4><p id="adminStatTotalUsers">0</p></div></div>
                        <div class="stat-item orders"><div class="stat-icon"><i class="fas fa-shopping-cart"></i></div><div class="stat-info"><h4>Total Orders</h4><p id="adminStatTotalOrders">0</p></div></div>
                        <div class="stat-item orders-today"><div class="stat-icon"><i class="fas fa-calendar-day"></i></div><div class="stat-info"><h4>Orders Today</h4><p id="adminStatOrdersToday">0</p></div></div>
                        <div class="stat-item user-balance"><div class="stat-icon"><i class="fas fa-university"></i></div><div class="stat-info"><h4>Total User Balance</h4><p id="adminStatTotalUserBalance">GH₵ 0.00</p></div></div>
                    </div>
                    <div class="admin-card">
                        <h3>Recent Orders (Last 10)</h3>
                        <div class="admin-table-wrapper"><table class="admin-table"><thead><tr><th>Order ID</th><th>User Email</th><th>Details</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead><tbody id="adminRecentOrdersTableBody"></tbody></table></div>
                        <div class="no-data-placeholder" id="noRecentOrdersPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-box-open"></i></div><h3>No recent orders found</h3></div>
                    </div>
                </div>

                <!-- Manage Users Tab -->
                <div id="manageUsersTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>All Users</h3>
                        <div class="admin-filters"><div class="filter-grid">
                            <div class="form-group"><label for="adminUserSearch">Search (Name, Email, UserID):</label><input type="text" id="adminUserSearch" class="form-input" placeholder="Enter search term"></div>
                            <div class="form-group"><label for="adminUserRoleFilter">Role:</label>
                                <select id="adminUserRoleFilter" class="form-select">
                                    <option value="all">All Roles</option>
                                    <option value="customer">Customer</option>
                                    <option value="agent">Agent</option>
                                    <option value="merchant">Merchant</option>
                                </select>
                            </div>
                        </div></div>
                        <div class="admin-table-wrapper"><table class="admin-table"><thead><tr><th>User ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Wallet</th><th>Role</th><th>2FA</th><th>Status</th><th>Joined</th><th>API Access</th><th>Actions</th></tr></thead><tbody id="adminUsersTableBody"></tbody></table></div>
                        <div class="no-data-placeholder" id="noAdminUsersPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-users-slash"></i></div><h3>No users match your criteria</h3></div>
                    </div>
                </div>
                
                <!-- Package Manager Tab -->
                <div id="packageManagerTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                             <h3>Manage Data Packages</h3>
                             <button id="addNewPackageBtn" class="form-submit-button"><i class="fas fa-plus"></i> Add New Package</button>
                        </div>
                        <div id="packagesCategorizedContainer"></div>
                        <div class="no-data-placeholder" id="noPackagesPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-box-open"></i></div><h3>No packages found.</h3><p>Click "Add New Package" to create one.</p></div>
                    </div>
                </div>

                <!-- Customer Orders Tab -->
                <div id="manageOrdersTab" class="admin-tab-content">
                     <div class="admin-card">
                        <h3>All Customer Orders</h3>

                        <!-- [UPDATED] Bulk Actions Section -->
                        <div class="admin-filters" id="bulkOrderActions" style="display: none; border-color: var(--admin-info); margin-top: 20px;">
                            <div class="filter-grid" style="grid-template-columns: 1fr auto; gap: 10px;">
                                <div class="form-group" style="margin-bottom:0;">
                                    <label for="bulkOrderStatusUpdate">Update status for selected orders:</label>
                                    <select id="bulkOrderStatusUpdate" class="form-select">
                                        <option value="" disabled selected>Select new status...</option>
                                        <option value="processing">Processing</option>
                                        <option value="completed">Completed</option>
                                        <option value="failed">Failed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <button class="form-submit-button" id="applyBulkUpdateBtn" style="background-color: var(--admin-info);">
                                    <i class="fas fa-check-double"></i> Apply
                                </button>
                            </div>
                        </div>

                         <div class="admin-filters"><div class="filter-grid">
                            <div class="form-group"><label for="adminOrderUserSearch">Filter by User (Email/Name/ID):</label><input type="text" id="adminOrderUserSearch" class="form-input" placeholder="Enter user details"></div>
                            <div class="form-group"><label for="adminOrderStatusFilter">Status:</label>
                                <select id="adminOrderStatusFilter" class="form-select">
                                    <option value="all">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="processing">Processing</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                         </div></div>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllOrdersCheckbox" title="Select All"></th>
                                        <th>Order ID</th>
                                        <th>User Email</th>
                                        <th>Details</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminOrdersTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noAdminOrdersPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-file-invoice"></i></div><h3>No orders match your criteria</h3></div>
                    </div>
                </div>

                <!-- Stores Tab -->
                <div id="storesTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>All Merchant Stores</h3>
                        <div class="admin-filters">
                            <div class="filter-grid">
                                <div class="form-group">
                                    <label for="storeSearch">Search (Name, Slug, Owner Email):</label>
                                    <input type="text" id="storeSearch" class="form-input" placeholder="Enter search term...">
                                </div>
                                <div class="form-group"><label for="storeApprovalFilter">Approval Status:</label>
                                    <select id="storeApprovalFilter" class="form-select">
                                        <option value="all">All</option>
                                        <option value="approved">Approved</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                </div>
                                <div class="form-group"><label for="storeBanFilter">Ban Status:</label>
                                    <select id="storeBanFilter" class="form-select">
                                        <option value="all">All</option>
                                        <option value="banned">Banned</option>
                                        <option value="active">Active</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Store Name</th>
                                        <th>Store URL (Slug)</th>
                                        <th>Owner Email</th>
                                        <th>Approval</th>
                                        <th>Ban Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="storesTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noStoresPlaceholder" style="display:none;">
                            <div class="icon"><i class="fas fa-store-alt-slash"></i></div>
                            <h3>No stores found.</h3>
                        </div>
                    </div>
                </div>


                <!-- Store Orders Tab -->
                <div id="storeOrdersTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>All Store Orders</h3>
                        <div class="admin-filters"><div class="filter-grid">
                            <div class="form-group"><label for="adminStoreOrderSearch">Filter by Merchant (Email/Name):</label><input type="text" id="adminStoreOrderSearch" class="form-input" placeholder="Enter merchant details"></div>
                             <div class="form-group"><label for="adminStoreOrderStatusFilter">Status:</label>
                                <select id="adminStoreOrderStatusFilter" class="form-select">
                                    <option value="all">All Statuses</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Processing">Processing</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Failed">Failed</option>
                                </select>
                            </div>
                        </div></div>
                        <div class="admin-table-wrapper"><table class="admin-table"><thead><tr><th>Order ID</th><th>Merchant</th><th>Customer Phone</th><th>Product</th><th>Profit</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody id="storeOrdersTableBody"></tbody></table></div>
                        <div class="no-data-placeholder" id="noStoreOrdersPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-store-alt-slash"></i></div><h3>No store orders found</h3></div>
                    </div>
                </div>

                <!-- Store Payouts Tab -->
                <div id="storePayoutsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>Store Payout Requests</h3>
                        <div class="admin-filters"><div class="filter-grid">
                           <div class="form-group"><label for="adminPayoutStatusFilter">Status:</label>
                                <select id="adminPayoutStatusFilter" class="form-select">
                                    <option value="all">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div></div>
                        <div class="admin-table-wrapper"><table class="admin-table"><thead><tr><th>Request ID</th><th>Merchant</th><th>Amount</th><th>MoMo Name</th><th>Phone</th><th>Network</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody id="storePayoutsTableBody"></tbody></table></div>
                        <div class="no-data-placeholder" id="noStorePayoutsPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-hand-holding-usd"></i></div><h3>No payout requests found</h3></div>
                    </div>
                </div>

                <!-- START: Online Courses Tab -->
                <div id="onlineCoursesTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                             <h3>Manage Online Courses</h3>
                             <button id="addNewCourseBtn" class="form-submit-button"><i class="fas fa-plus"></i> Add New Course</button>
                        </div>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Type</th>
                                        <th>Lessons</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="onlineCoursesTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noOnlineCoursesPlaceholder" style="display:none;">
                            <div class="icon"><i class="fas fa-book"></i></div>
                            <h3>No courses found.</h3>
                            <p>Click "Add New Course" to create one.</p>
                        </div>
                    </div>
                </div>
                <!-- END: Online Courses Tab -->

                <!-- START: Course Purchases Tab -->
                <div id="coursePurchasesTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>Course Purchase History</h3>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Purchase ID</th>
                                        <th>User Email</th>
                                        <th>Course Title</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="coursePurchasesTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noCoursePurchasesPlaceholder" style="display:none;">
                            <div class="icon"><i class="fas fa-receipt"></i></div>
                            <h3>No course purchases found.</h3>
                        </div>
                    </div>
                </div>
                <!-- END: Course Purchases Tab -->

                <!-- Marketplace Banners Tab -->
                <div id="marketplaceBannersTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                            <h3>Marketplace Banners</h3>
                            <button id="addNewBannerBtn" class="form-submit-button"><i class="fas fa-plus"></i> Add New Banner</button>
                        </div>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead><tr><th>Order</th><th>Image Preview</th><th>Image URL</th><th>Actions</th></tr></thead>
                                <tbody id="marketplaceBannersTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noMarketplaceBannersPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-image"></i></div><h3>No banners found.</h3></div>
                    </div>
                </div>

                <!-- Marketplace Categories Tab -->
                <div id="marketplaceCategoriesTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                            <h3>Marketplace Categories</h3>
                            <button id="addNewCategoryBtn" class="form-submit-button"><i class="fas fa-plus"></i> Add New Category</button>
                        </div>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead><tr><th>Order</th><th>Name</th><th>Actions</th></tr></thead>
                                <tbody id="marketplaceCategoriesTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noMarketplaceCategoriesPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-tags"></i></div><h3>No categories found.</h3></div>
                    </div>
                </div>

                <!-- Marketplace Products Tab -->
                <div id="marketplaceProductsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                            <h3>Marketplace Products</h3>
                            <button id="addNewProductBtn" class="form-submit-button"><i class="fas fa-plus"></i> Add New Product</button>
                        </div>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead><tr><th>Name</th><th>Category</th><th>Type</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="marketplaceProductsTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noMarketplaceProductsPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-shopping-bag"></i></div><h3>No products found.</h3></div>
                    </div>
                </div>

                <!-- Website Queue Tab -->
                <div id="websiteQueueTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>Queued Website Orders</h3>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead><tr><th>Date</th><th>Customer Email</th><th>Site Name</th><th>WhatsApp</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="websiteQueueTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noWebsiteQueuePlaceholder" style="display:none;"><div class="icon"><i class="fas fa-hourglass-half"></i></div><h3>The queue is empty.</h3></div>
                    </div>
                </div>

                <!-- REMOVED: Manual Top Ups Tab - Feature no longer used -->
                <!--
                <div id="manualTopUpsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>Manual Top-Up Requests</h3>
                        <div class="admin-filters">
                            <div class="filter-grid">
                                <div class="form-group">
                                    <label for="manualTopUpSearch">Search (User Email / Reference):</label>
                                    <input type="text" id="manualTopUpSearch" class="form-input" placeholder="Enter search term...">
                                </div>
                                <div class="form-group">
                                    <label for="manualTopUpStatusFilter">Status:</label>
                                    <select id="manualTopUpStatusFilter" class="form-select">
                                        <option value="all">All</option>
                                        <option value="pending">Pending</option>
                                        <option value="completed">Completed (Approved)</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Requested At</th>
                                        <th>User Email</th>
                                        <th>Amount</th>
                                        <th>Reference</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="manualTopUpsTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noManualTopUpsPlaceholder" style="display:none;">
                            <div class="icon"><i class="fas fa-inbox"></i></div>
                            <h3>No requests match your criteria</h3>
                        </div>
                    </div>
                </div>
                -->


                <!-- AFA Registrations Tab -->
                <div id="manageAfaRegistrationsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>AFA Registrations</h3>
                        <div class="admin-filters"><div class="filter-grid">
                            <div class="form-group"><label for="adminAfaSearch">Search (Name, Phone):</label><input type="text" id="adminAfaSearch" class="form-input" placeholder="Enter search term"></div>
                            <div class="form-group"><label for="adminAfaStatusFilter">Status:</label>
                                <select id="adminAfaStatusFilter" class="form-select">
                                    <option value="all">All</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                        </div></div>
                        <div class="admin-table-wrapper"><table class="admin-table"><thead><tr><th>Date</th><th>Submitted By (Email)</th><th>Full Name</th><th>Phone</th><th>Ghana Card</th><th>Status</th><th>Actions</th></tr></thead><tbody id="adminAfaRegTableBody"></tbody></table></div>
                        <div class="no-data-placeholder" id="noAdminAfaRegPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-address-card"></i></div><h3>No AFA registrations found</h3></div>
                    </div>
                </div>
                
                <!-- Notifications Tab -->
                <div id="notificationsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>Send Notification</h3>
                        <form id="sendNotificationForm">
                            <div class="form-group">
                                <label for="notificationTitle">Title</label>
                                <input type="text" id="notificationTitle" class="form-input" placeholder="e.g. System Update" required>
                            </div>
                            <div class="form-group">
                                <label for="notificationText">Message</label>
                                <textarea id="notificationText" class="form-textarea" rows="3" placeholder="Enter the notification message" required></textarea>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div class="form-group">
                                    <label for="notificationType">Type</label>
                                    <select id="notificationType" class="form-select">
                                        <option value="info">Info (Blue)</option>
                                        <option value="success">Success (Green)</option>
                                        <option value="warning">Warning (Yellow)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="notificationTarget">Target Audience</label>
                                    <select id="notificationTarget" class="form-select">
                                        <option value="all">All Users</option>
                                        <option value="specific">Specific User</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" id="specificUserField" style="display: none;">
                                <label for="notificationUserEmail">User's Email</label>
                                <input type="email" id="notificationUserEmail" class="form-input" placeholder="Enter the user's email address">
                            </div>
                            <button type="submit" class="form-submit-button" id="sendNotificationBtn">
                                <i class="fas fa-paper-plane"></i> <span class="btn-text">Send Notification</span><span class="spinner"></span>
                            </button>
                        </form>
                    </div>

                    <div class="admin-card">
                        <h3>Sent Notifications (Recent 20)</h3>
                        <div class="admin-table-wrapper">
                            <table class="admin-table">
                                <thead><tr><th>Title</th><th>Message</th><th>Target</th><th>Date</th><th>Actions</th></tr></thead>
                                <tbody id="sentNotificationsTableBody"></tbody>
                            </table>
                        </div>
                        <div class="no-data-placeholder" id="noSentNotificationsPlaceholder" style="display:none;"><div class="icon"><i class="fas fa-history"></i></div><h3>No notifications sent yet</h3></div>
                    </div>
                </div>

                <!-- Controls Tab -->
                <div id="controlsTab" class="admin-tab-content">
                    <div class="admin-card">
                        <h3>Site & Service Controls</h3>
                        <form id="siteSettingsForm">
                            
                            <div class="sub-section">
                                <h5>API & Integration</h5>
                                <div class="api-balance-card">
                                    <div class="balance-info">
                                        <div class="label">DatafyHub API Balance</div>
                                        <div class="value loading" id="apiBalanceValue">Loading...</div>
                                    </div>
                                    <button type="button" class="balance-refresh-btn" id="refreshBalanceBtn" aria-label="Refresh Balance">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                                    </button>
                                </div>

                                <div class="form-group">
                                    <label>Enable Auto Processing via API:</label>
                                    <label class="switch"><input type="checkbox" id="processingModeToggle"><span class="slider"></span></label>
                                    <p class="info-text">When ON, data orders will be processed automatically. When OFF, they will be set to 'pending' for manual processing.</p>
                                </div>
                                
                                <div class="api-token-group">
                                    <label for="bearerTokenInput">DatafyHub Bearer Token</label>
                                    <input type="password" id="bearerTokenInput" class="form-input" placeholder="Enter new API Bearer Token">
                                    <button type="button" class="form-submit-button" id="saveTokenBtn"><i class="fas fa-key"></i> <span class="btn-text">Save Token</span><span class="spinner"></span></button>
                                </div>

                                <!-- Provider Configuration -->
                                <div class="api-token-group" style="margin-top:16px;">
                                    <label for="providerTokenInputAdmin">Provider API Token (Datafy or other)</label>
                                    <input type="password" id="providerTokenInputAdmin" class="form-input" placeholder="Enter provider API token">
                                </div>
                                <div class="api-token-group">
                                    <label for="providerUrlInputAdmin">Provider Endpoint (optional)</label>
                                    <input type="text" id="providerUrlInputAdmin" class="form-input" placeholder="https://api.datafyhub.com/api/v1/placeOrder">
                                </div>
                                <div class="form-group" style="display:flex; align-items:center; gap:12px;">
                                    <label style="margin:0;">Enable Direct Order Processing</label>
                                    <label class="switch"><input type="checkbox" id="providerDirectToggleAdmin"><span class="slider"></span></label>
                                    <div class="info-text">When enabled, orders will be sent directly to the provider from the client. Use with caution.</div>
                                </div>
                                <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                                    <button type="button" class="form-submit-button" id="saveProviderConfigBtnAdmin"><i class="fas fa-save"></i> <span class="btn-text">Save Provider Config</span><span class="spinner"></span></button>
                                    <div id="providerConfigStatusAdmin" class="info-text">Status: Not saved</div>
                                </div>
                            </div>

                            <div class="sub-section">
                                <h5>Payment Method Controls</h5>
                                <div class="form-group">
                                    <label>Enable Instant Top Up (Paystack):</label>
                                    <label class="switch"><input type="checkbox" id="instantTopUpToggle"><span class="slider"></span></label>
                                </div>
                                <!-- REMOVED: Manual Top Up toggle - Feature no longer used -->
                                <!--
                                <div class="form-group">
                                    <label>Enable Manual Top Up (MoMo):</label>
                                    <label class="switch"><input type="checkbox" id="manualTopUpToggle"><span class="slider"></span></label>
                                </div>
                                -->
                                <div class="form-group">
                                    <label for="paystackPublicKeyInput">Paystack Public Key:</label>
                                    <input type="text" id="paystackPublicKeyInput" class="form-input" placeholder="pk_live_...">
                                </div>
                                 <div class="form-group">
                                    <label for="paystackSecretKeyInput">Paystack Secret Key:</label>
                                    <input type="password" id="paystackSecretKeyInput" class="form-input" placeholder="sk_live_...">
                                     <p class="info-text">Warning: Changing this key is critical and should be done with caution.</p>
                                </div>
                            </div>
                            
                            <!-- [UPDATED] Global Store Controls section added -->
                            <div class="sub-section">
                                <h5>Global Store Controls</h5>
                                <div class="form-group">
                                    <label for="storePaystackPublicKeyInput">Store Paystack Public Key:</label>
                                    <input type="text" id="storePaystackPublicKeyInput" class="form-input" placeholder="pk_live_...">
                                    <p class="info-text">This Paystack public key will be used for all merchant store purchases via popup payment.</p>
                                </div>
                                <div class="form-group">
                                    <label>Close All Merchant Stores (Show "Closed" Overlay):</label>
                                    <label class="switch"><input type="checkbox" id="closeAllStoresToggle"><span class="slider"></span></label>
                                    <p class="info-text">If enabled, all public merchant stores will display a "temporarily closed" message.</p>
                                </div>
                                <div class="form-group">
                                    <label>Disable Purchases on Sunday:</label>
                                    <label class="switch"><input type="checkbox" id="disableSundayPurchasesToggle"><span class="slider"></span></label>
                                    <p class="info-text">If enabled, the "Buy Data" button on the user dashboard will show a popup on Sundays.</p>
                                </div>
                            </div>

                            <div class="sub-section">
                                <h5>General Settings</h5>
                                <div class="form-group">
                                    <label for="goldenTicketPriceInput">Golden Ticket Price (GH₵):</label>
                                    <input type="number" step="0.01" id="goldenTicketPriceInput" class="form-input" placeholder="e.g. 40.00">
                                </div>
                                <div class="form-group">
                                    <label>Maintenance Mode:</label>
                                    <label class="switch"><input type="checkbox" id="maintenanceModeToggle"><span class="slider"></span></label>
                                    <p class="info-text">If enabled, the entire user dashboard will display a maintenance message.</p>
                                </div>
                                <div class="form-group">
                                    <label for="maintenanceMessageInput">Maintenance Message:</label>
                                    <textarea id="maintenanceMessageInput" class="form-textarea" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Disable New Registrations:</label>
                                    <label class="switch"><input type="checkbox" id="registrationDisabledToggle"><span class="slider"></span></label>
                                </div>
                                <div class="form-group">
                                    <label>Require Admin Approval for New Users:</label>
                                    <label class="switch"><input type="checkbox" id="registrationApprovalRequiredToggle"><span class="slider"></span></label>
                                    <p class="info-text">If enabled, new users (merchants) will need manual approval from the 'Users' tab before they can access their dashboards.</p>
                                </div>
                            </div>
                            
                            <div class="sub-section">
                                <h5>Service Availability</h5>
                                <div class="form-group">
                                    <label>AFA Registration Service:</label>
                                    <label class="switch"><input type="checkbox" id="afaRegistrationToggle"><span class="slider"></span></label>
                                </div>
                                <div class="form-group">
                                    <label>AFA Mins Packages:</label>
                                    <label class="switch"><input type="checkbox" id="afaMinsToggle"><span class="slider"></span></label>
                                </div>
                            </div>

                            <div class="sub-section">
                                <h5>Dashboard Notification Banner</h5>
                                <div class="form-group"><label>Enable Banner:</label><label class="switch"><input type="checkbox" id="bannerIsActiveToggle"><span class="slider"></span></label></div>
                                <div class="form-group"><label for="bannerImageUrlInput">Banner Image URL:</label><input type="url" id="bannerImageUrlInput" class="form-input" placeholder="https://example.com/image.png"></div>
                                <div class="form-group"><label for="bannerTitleInput">Banner Title:</label><input type="text" id="bannerTitleInput" class="form-input" placeholder="e.g. Special Announcement"></div>
                                <div class="form-group"><label for="bannerDescriptionInput">Banner Description:</label><textarea id="bannerDescriptionInput" class="form-textarea" rows="2" placeholder="Briefly describe the notification"></textarea></div>
                                <div class="form-group"><label>Enable Button:</label><label class="switch"><input type="checkbox" id="bannerIsButtonActiveToggle"><span class="slider"></span></label></div>
                                <div id="bannerButtonFields" style="display: none;">
                                    <div class="form-group"><label for="bannerButtonTextInput">Button Text:</label><input type="text" id="bannerButtonTextInput" class="form-input" placeholder="e.g. Learn More"></div>
                                    <div class="form-group"><label for="bannerButtonLinkInput">Button Link:</label><input type="url" id="bannerButtonLinkInput" class="form-input" placeholder="https://example.com/more-info"></div>
                                </div>
                            </div>
                             
                            <div class="sub-section">
                                <h5>Store Moderation</h5>
                                <div class="form-group">
                                    <label for="storeSlugToBan">Merchant Store Slug:</label>
                                    <input type="text" id="storeSlugToBan" class="form-input" placeholder="e.g., gigsplan">
                                </div>
                                <div style="display:flex; gap: 10px;">
                                    <button type="button" class="form-submit-button" id="banStoreBtn" style="background-color: var(--admin-danger);"><i class="fas fa-store-alt-slash"></i> Ban Store</button>
                                    <button type="button" class="form-submit-button" id="unbanStoreBtn" style="background-color: var(--admin-success);"><i class="fas fa-store"></i> Unban Store</button>
                                </div>
                            </div>

                           
                            <button type="submit" class="form-submit-button" id="saveSiteSettingsBtn" style="margin-top: 20px;"><i class="fas fa-save"></i> <span class="btn-text">Save All Settings</span><span class="spinner"></span></button>
                        </form>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- ========= MODALS ========= -->
    <div class="modal-overlay" id="userEditModal">
        <div class="modal-content">
            <h3>Edit User Details <button type="button" class="close-modal-btn" data-modal-id="userEditModal"><i class="fas fa-times"></i></button></h3>
            <form id="adminEditUserForm">
                <input type="hidden" id="adminEditUserId">
                <div class="info-readonly-group"><strong>Email:</strong><p id="adminEditUserEmail"></p></div>
                <div class="form-group"><label for="adminEditUserName">Full Name:</label><input type="text" id="adminEditUserName" class="form-input"></div>
                <div class="form-group"><label for="adminEditUserPhone">Phone:</label><input type="tel" id="adminEditUserPhone" class="form-input"></div>
                <div class="form-group"><label for="adminEditUserWalletBalance">Wallet Balance (GH₵):</label><input type="number" step="0.01" id="adminEditUserWalletBalance" class="form-input"></div>
                <div class="form-group"><label>Account Approved:</label><label class="switch"><input type="checkbox" id="adminEditUserIsApproved"><span class="slider"></span></label></div>
                <div class="form-group"><label>Golden Ticket / Agent Status:</label><label class="switch"><input type="checkbox" id="adminEditUserIsAgent"><span class="slider"></span></label></div>
                <div class="form-group"><label>Two-Factor Authentication (2FA):</label><label class="switch"><input type="checkbox" id="adminEditUser2FAEnabled"><span class="slider"></span></label><p class="info-text">Enable or disable 2FA for this user</p></div>
                <div class="form-group"><label for="adminEditUser2FAPhone">2FA Phone Number:</label><input type="tel" id="adminEditUser2FAPhone" class="form-input" placeholder="+233XXXXXXXXX"><p class="info-text">Phone number for 2FA verification (international format)</p></div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-modal-id="userEditModal">Cancel</button>
                    <button type="submit" class="modal-btn confirm" id="adminSaveUserChangesBtn"><i class="fas fa-save"></i> <span class="btn-text">Save Changes</span><span class="spinner"></span></button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="packageEditModal">
        <div class="modal-content">
            <h3 id="packageModalTitle">Add New Package <button type="button" class="close-modal-btn" data-modal-id="packageEditModal"><i class="fas fa-times"></i></button></h3>
            <form id="packageForm">
                <input type="hidden" id="packageId">
                <div class="form-group">
                    <label for="packageNetwork">Network Category</label>
                    <select id="packageNetwork" class="form-select" required>
                        <option value="" disabled selected>Select a network</option>
                        <option value="mtn">MTN</option>
                        <option value="telecel">Telecel</option>
                        <option value="at">AirtelTigo</option>
                        <option value="afa_mins">Afa Mins</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="packageName">Package Name (e.g., 5GB, 100GB, 500 Mins)</label>
                    <input type="text" id="packageName" class="form-input" required placeholder="e.g. 10GB">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="packageDataSize">Data Size (e.g., 5GB, 10GB)</label>
                        <input type="text" id="packageDataSize" class="form-input" placeholder="e.g. 5GB">
                    </div>
                    <div class="form-group">
                        <label for="packageValidity">Validity (e.g., 30 Days, 7 Days)</label>
                        <input type="text" id="packageValidity" class="form-input" placeholder="e.g. 30 Days">
                    </div>
                </div>
                <div class="form-group">
                    <label for="packageDescription">Description (Optional)</label>
                    <input type="text" id="packageDescription" class="form-input" placeholder="e.g. Perfect for streaming and browsing">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="packageCustomerPrice">Customer Price (GH₵)</label>
                        <input type="number" id="packageCustomerPrice" class="form-input" step="0.01" required placeholder="e.g. 15.50">
                    </div>
                    <div class="form-group">
                        <label for="packageAgentPrice">Agent Price (GH₵)</label>
                        <input type="number" id="packageAgentPrice" class="form-input" step="0.01" required placeholder="e.g. 14.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Package Status</label>
                    <label class="switch"><input type="checkbox" id="packageIsActive" checked><span class="slider"></span></label> <span style="margin-left:10px; font-size:12px;">Active</span>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-modal-id="packageEditModal">Cancel</button>
                    <button type="submit" class="modal-btn confirm" id="savePackageBtn"><i class="fas fa-save"></i> <span class="btn-text">Save Package</span><span class="spinner"></span></button>
                </div>
            </form>
        </div>
    </div>

    <!-- START: Online Course Edit/Add Modal -->
    <div class="modal-overlay" id="courseEditModal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 id="courseModalTitle">Add New Course <button type="button" class="close-modal-btn" data-modal-id="courseEditModal"><i class="fas fa-times"></i></button></h3>
            <form id="courseForm">
                <input type="hidden" id="courseId">
                <div class="form-group">
                    <label for="courseTitle">Course Title</label>
                    <input type="text" id="courseTitle" class="form-input" required placeholder="e.g., Executive Diploma in Business">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="courseCategory">Category</label>
                        <input type="text" id="courseCategory" class="form-input" required placeholder="e.g., Business Communication">
                    </div>
                    <div class="form-group">
                        <label for="courseType">Type</label>
                        <select id="courseType" class="form-select" required>
                            <option value="Free">Free</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="courseDescription">Description</label>
                    <textarea id="courseDescription" class="form-textarea" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="courseThumbnailUrl">Thumbnail URL</label>
                    <input type="url" id="courseThumbnailUrl" class="form-input" required placeholder="https://example.com/thumbnail.jpg">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="courseBadges">Badges (comma-separated)</label>
                        <input type="text" id="courseBadges" class="form-input" placeholder="e.g., New, Popular, Beginner">
                    </div>
                    <div class="form-group">
                        <label for="courseDuration">Duration</label>
                        <input type="text" id="courseDuration" class="form-input" required placeholder="e.g., 2-3 Weeks Learning">
                    </div>
                </div>
                 <div class="form-group">
                    <label for="courseVideoUrl">Main Course Video URL (YouTube Embed)</label>
                    <input type="url" id="courseVideoUrl" class="form-input" placeholder="https://www.youtube.com/embed/VIDEO_ID">
                </div>
                
                <div class="sub-section">
                    <h5>Course Lessons</h5>
                    <div id="lesson-fields-container">
                        <!-- Dynamic lesson fields will be added here -->
                    </div>
                    <button type="button" id="add-lesson-field-btn" class="form-submit-button" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-plus"></i> Add Lesson
                    </button>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Course Status</label>
                    <label class="switch"><input type="checkbox" id="courseIsActive" checked><span class="slider"></span></label> <span style="margin-left:10px; font-size:12px;">Active</span>
                </div>

                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-modal-id="courseEditModal">Cancel</button>
                    <button type="submit" class="modal-btn confirm" id="saveCourseBtn"><i class="fas fa-save"></i> <span class="btn-text">Save Course</span><span class="spinner"></span></button>
                </div>
            </form>
        </div>
    </div>
    <!-- END: Online Course Edit/Add Modal -->

    <!-- Marketplace Banner Modal -->
    <div class="modal-overlay" id="bannerModal">
        <div class="modal-content">
            <h3 id="bannerModalTitle">Add New Banner <button type="button" class="close-modal-btn" data-modal-id="bannerModal"><i class="fas fa-times"></i></button></h3>
            <form id="bannerForm">
                <input type="hidden" id="bannerId">
                <div class="form-group">
                    <label for="bannerImageUrl">Image URL</label>
                    <input type="url" id="bannerImageUrl" class="form-input" required placeholder="https://example.com/image.png">
                </div>
                <div class="form-group">
                    <label for="bannerOrder">Display Order (e.g., 1, 2, 3)</label>
                    <input type="number" id="bannerOrder" class="form-input" required placeholder="1">
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-modal-id="bannerModal">Cancel</button>
                    <button type="submit" class="modal-btn confirm" id="saveBannerBtn"><i class="fas fa-save"></i> <span class="btn-text">Save Banner</span><span class="spinner"></span></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Marketplace Category Modal -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal-content">
            <h3 id="categoryModalTitle">Add New Category <button type="button" class="close-modal-btn" data-modal-id="categoryModal"><i class="fas fa-times"></i></button></h3>
            <form id="categoryForm">
                <input type="hidden" id="categoryId">
                <div class="form-group">
                    <label for="categoryName">Category Name</label>
                    <input type="text" id="categoryName" class="form-input" required placeholder="e.g., Ready-made Websites">
                </div>
                <div class="form-group">
                    <label for="categoryOrder">Display Order (e.g., 1, 2, 3)</label>
                    <input type="number" id="categoryOrder" class="form-input" required placeholder="1">
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-modal-id="categoryModal">Cancel</button>
                    <button type="submit" class="modal-btn confirm" id="saveCategoryBtn"><i class="fas fa-save"></i> <span class="btn-text">Save Category</span><span class="spinner"></span></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Marketplace Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal-content">
            <h3 id="productModalTitle">Add New Product <button type="button" class="close-modal-btn" data-modal-id="productModal"><i class="fas fa-times"></i></button></h3>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName">Product Name</label>
                    <input type="text" id="productName" class="form-input" required placeholder="e.g., E-commerce Website">
                </div>
                <div class="form-group">
                    <label for="productDescription">Short Description</label>
                    <textarea id="productDescription" class="form-textarea" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="productImageUrl">Image URL</label>
                    <input type="url" id="productImageUrl" class="form-input" required placeholder="https://example.com/product_image.png">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="productCategoryId">Category</label>
                        <select id="productCategoryId" class="form-select" required></select>
                    </div>
                    <div class="form-group">
                        <label for="productType">Product Type</label>
                        <select id="productType" class="form-select" required>
                            <option value="Website">Website</option>
                            <option value="Online Course">Online Course</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Is this a paid product?</label>
                    <label class="switch"><input type="checkbox" id="productIsPaid"><span class="slider"></span></label>
                </div>
                <div class="form-group" id="productPriceField" style="display:none;">
                    <label for="productPrice">Price (GH₵)</label>
                    <input type="number" step="0.01" id="productPrice" class="form-input" placeholder="0.00">
                </div>
                 <div class="form-group" id="productVideoUrlField" style="display:none;">
                    <label for="productVideoUrl">Course Video URL (YouTube Embed Link)</label>
                    <input type="url" id="productVideoUrl" class="form-input" placeholder="https://www.youtube.com/embed/VIDEO_ID">
                </div>
                <hr style="border: none; border-top: 1px solid var(--admin-border-color); margin: 20px 0;">
                <div class="form-group">
                    <label>Activate Live Demo button?</label>
                    <label class="switch"><input type="checkbox" id="productIsLiveDemoActive"><span class="slider"></span></label>
                </div>
                <div class="form-group" id="productLiveDemoLinkField" style="display:none;">
                    <label for="productLiveDemoLink">Live Demo Link</label>
                    <input type="url" id="productLiveDemoLink" class="form-input" placeholder="https://demo.example.com">
                </div>

                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-modal-id="productModal">Cancel</button>
                    <button type="submit" class="modal-btn confirm" id="saveProductBtn"><i class="fas fa-save"></i> <span class="btn-text">Save Product</span><span class="spinner"></span></button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Website Queue Update Modal -->
    <div class="modal-overlay" id="websiteQueueUpdateModal">
        <div class="modal-content">
            <h3>Update Website Order Status <button type="button" class="close-modal-btn" data-modal-id="websiteQueueUpdateModal"><i class="fas fa-times"></i></button></h3>
            <div id="websiteQueueDetailsContent"></div>
             <div class="form-group" style="margin-top:20px;">
                <label for="websiteQueueUpdateStatusSelect">Update Status:</label>
                <select id="websiteQueueUpdateStatusSelect" class="form-select">
                    <option value="queued">Queued</option>
                    <option value="processing">Processing</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="modal-actions">
                 <button type="button" class="modal-btn cancel" data-modal-id="websiteQueueUpdateModal">Close</button>
                 <button type="button" class="modal-btn confirm" id="confirmUpdateWebsiteQueueStatusBtn"><i class="fas fa-check-circle"></i> Update Status</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="notificationEditModal">
        <div class="modal-content">
            <h3>Edit Notification <button type="button" class="close-modal-btn" data-modal-id="notificationEditModal"><i class="fas fa-times"></i></button></h3>
            <form id="editNotificationForm">
                <input type="hidden" id="editNotificationId">
                <div class="form-group">
                    <label for="editNotificationTitle">Title</label>
                    <input type="text" id="editNotificationTitle" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="editNotificationText">Message</label>
                    <textarea id="editNotificationText" class="form-textarea" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editNotificationType">Type</label>
                    <select id="editNotificationType" class="form-select">
                        <option value="info">Info (Blue)</option>
                        <option value="success">Success (Green)</option>
                        <option value="warning">Warning (Yellow)</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" data-modal-id="notificationEditModal">Cancel</button>
                    <button type="submit" class="modal-btn confirm" id="saveNotificationChangesBtn"><i class="fas fa-save"></i> <span class="btn-text">Save Changes</span><span class="spinner"></span></button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="orderUpdateModal">
        <div class="modal-content">
            <h3>Update Order Status <button type="button" class="close-modal-btn" data-modal-id="orderUpdateModal"><i class="fas fa-times"></i></button></h3>
            <div id="orderDetailsContent" class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
             <div class="form-group" style="margin-top:20px;">
                <label for="orderUpdateStatusSelect">Update Status:</label>
                <select id="orderUpdateStatusSelect" class="form-select">
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="modal-actions">
                 <button type="button" class="modal-btn cancel" data-modal-id="orderUpdateModal">Close</button>
                 <button type="button" class="modal-btn confirm" id="confirmUpdateOrderStatusBtn"><i class="fas fa-check-circle"></i> Update Status</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="storeOrderUpdateModal">
        <div class="modal-content">
            <h3>Update Store Order <button type="button" class="close-modal-btn" data-modal-id="storeOrderUpdateModal"><i class="fas fa-times"></i></button></h3>
            <div id="storeOrderDetailsContent" class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
             <div class="form-group" style="margin-top:20px;">
                <label for="storeOrderUpdateStatusSelect">Update Status:</label>
                <select id="storeOrderUpdateStatusSelect" class="form-select">
                    <option value="Pending">Pending</option>
                    <option value="Processing">Processing</option>
                    <option value="Completed">Completed</option>
                    <option value="Failed">Failed</option>
                </select>
            </div>
            <div class="modal-actions">
                 <button type="button" class="modal-btn cancel" data-modal-id="storeOrderUpdateModal">Close</button>
                 <button type="button" class="modal-btn confirm" id="confirmUpdateStoreOrderStatusBtn"><i class="fas fa-check-circle"></i> Update Status</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="payoutUpdateModal">
        <div class="modal-content">
            <h3>Process Payout Request <button type="button" class="close-modal-btn" data-modal-id="payoutUpdateModal"><i class="fas fa-times"></i></button></h3>
            <div id="payoutDetailsContent" class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
            <div class="modal-actions">
                 <button type="button" class="modal-btn cancel" data-modal-id="payoutUpdateModal">Cancel</button>
                 <button type="button" class="modal-btn danger" id="rejectPayoutBtn"><i class="fas fa-times-circle"></i> Reject</button>
                 <button type="button" class="modal-btn confirm" id="approvePayoutBtn"><i class="fas fa-check-circle"></i> Mark as Paid</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="afaDetailsModal">
        <div class="modal-content">
            <h3>AFA Details <button type="button" class="close-modal-btn" data-modal-id="afaDetailsModal"><i class="fas fa-times"></i></button></h3>
            <div id="afaDetailsContent" class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
             <div class="form-group" style="margin-top:20px;">
                <label for="afaUpdateStatusSelect">Update Status:</label>
                <select id="afaUpdateStatusSelect" class="form-select">
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
            <div class="modal-actions">
                 <button type="button" class="modal-btn cancel" data-modal-id="afaDetailsModal">Close</button>
                 <button type="button" class="modal-btn confirm" id="confirmUpdateAfaStatusBtn"><i class="fas fa-check-circle"></i> Update Status</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
        // ===================================================================================
        // FIREBASE SETUP & CONFIGURATION
        // ===================================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, setDoc, addDoc, collection, query, getDocs, updateDoc,
            deleteDoc, serverTimestamp, orderBy, limit, where, writeBatch, increment
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
  apiKey: "AIzaSyD_YTYess5I3Uuf7X9g-3qlfVHR4FY1NSQ",
  authDomain: "quickxpress-55347.firebaseapp.com",
  projectId: "quickxpress-55347",
  storageBucket: "quickxpress-55347.firebasestorage.app",
  messagingSenderId: "645813936880",
  appId: "1:645813936880:web:43ee96c1fa548631751835"
};

        // -----------------------------------------


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- SET YOUR ADMIN EMAIL HERE ---
        const ADMIN_EMAIL = "gamelessdean11@gmail.com";
        // ---------------------------------

        // Global State
        let allUsersCache = [];
        let marketplaceCategoriesCache = [];
        let currentEditingAfaId = null;
        let currentEditingPackageId = null;
        let currentEditingPackageNetwork = null; // ✅ Track network for package editing
        let currentEditingOrderId = null;
        let currentEditingStoreOrderId = null; 
        let currentEditingPayoutId = null; 
        let currentEditingNotificationId = null;
        let currentEditingBannerId = null;
        let currentEditingCategoryId = null;
        let currentEditingProductId = null;
        let currentEditingWebsiteQueueId = null;
        let currentApiToken = null;
        let currentEditingCourseId = null; // New for courses

        // DOM Elements
        const adminLoader = document.getElementById('adminLoader');
        const adminLoginWrapper = document.getElementById('adminLoginWrapper');
        const adminPanelContainer = document.getElementById('adminPanelContainer');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminNavLinks = document.querySelectorAll('.admin-nav-link');
        const adminPageTopBarTitle = document.getElementById('adminPageTopBarTitle');
        const adminMenuToggle = document.getElementById('adminMenuToggle');
        const adminSidebar = document.getElementById('adminSidebar');
        const adminSidebarOverlay = document.getElementById('adminSidebarOverlay');
        
        const apiBalanceValueEl = document.getElementById('apiBalanceValue');
        const refreshBalanceBtn = document.getElementById('refreshBalanceBtn');
        const processingModeToggle = document.getElementById('processingModeToggle');
        const bearerTokenInput = document.getElementById('bearerTokenInput');
        const saveTokenBtn = document.getElementById('saveTokenBtn');

        // Payment Method Toggles
        const instantTopUpToggle = document.getElementById('instantTopUpToggle');
        // REMOVED: Manual top-up feature no longer used
        // const manualTopUpToggle = document.getElementById('manualTopUpToggle');
        const paystackPublicKeyInput = document.getElementById('paystackPublicKeyInput');
        const paystackSecretKeyInput = document.getElementById('paystackSecretKeyInput'); // NEW

        // Store Controls Toggles
        const storePaystackPublicKeyInput = document.getElementById('storePaystackPublicKeyInput'); // NEW
        const closeAllStoresToggle = document.getElementById('closeAllStoresToggle'); // NEW
        const disableSundayPurchasesToggle = document.getElementById('disableSundayPurchasesToggle'); // NEW

        // General Settings
        const goldenTicketPriceInput = document.getElementById('goldenTicketPriceInput');
        const maintenanceModeToggle = document.getElementById('maintenanceModeToggle');
        const maintenanceMessageInput = document.getElementById('maintenanceMessageInput');
        const registrationDisabledToggle = document.getElementById('registrationDisabledToggle');
        const registrationApprovalRequiredToggle = document.getElementById('registrationApprovalRequiredToggle');

        // Service Availability Toggles
        const afaRegistrationToggle = document.getElementById('afaRegistrationToggle');
        const afaMinsToggle = document.getElementById('afaMinsToggle');

        // Dashboard Notification Banner
        const bannerIsActiveToggle = document.getElementById('bannerIsActiveToggle');
        const bannerImageUrlInput = document.getElementById('bannerImageUrlInput');
        const bannerTitleInput = document.getElementById('bannerTitleInput');
        const bannerDescriptionInput = document.getElementById('bannerDescriptionInput');
        const bannerIsButtonActiveToggle = document.getElementById('bannerIsButtonActiveToggle');
        const bannerButtonFields = document.getElementById('bannerButtonFields');
        const bannerButtonTextInput = document.getElementById('bannerButtonTextInput');
        const bannerButtonLinkInput = document.getElementById('bannerButtonLinkInput');

        // Store Moderation
        const storeSlugToBan = document.getElementById('storeSlugToBan');
        const banStoreBtn = document.getElementById('banStoreBtn');
        const unbanStoreBtn = document.getElementById('unbanStoreBtn');

        // ===================================================================================
        // UTILITY FUNCTIONS
        // ===================================================================================
        // Convert international Ghana numbers (233XXXXXXXXX) to local 0XXXXXXXXX for display
        function intlToLocal(phone) {
            if (!phone) return phone;
            const s = String(phone).trim();
            if (s.startsWith('233') && s.length === 12) {
                return '0' + s.substring(3);
            }
            // If number already starts with 0 and is 10 digits, return as-is
            if (s.startsWith('0') && s.length === 10) return s;
            // If number is 9 digits (missing leading 0), prefix 0
            if (/^\d{9}$/.test(s)) return '0' + s;
            return s; // fallback
        }

        const showToast = (title, icon = 'success', text = '') => Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 4000, timerProgressBar: true, icon, title, text });
        const toggleButtonLoading = (button, isLoading) => {
            if (!button) return;
            button.disabled = isLoading;
            button.classList.toggle('loading', isLoading);
        };
        const openModal = (modalId) => document.getElementById(modalId)?.classList.add('active');
        const closeModal = (modalId) => document.getElementById(modalId)?.classList.remove('active');
        document.querySelectorAll('.close-modal-btn, .modal-btn.cancel').forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.modalId)));
        const formatDate = (timestamp) => timestamp && timestamp.toDate ? new Date(timestamp.toDate()).toLocaleDateString('en-GB') : 'N/A';
        const formatCurrency = (amount) => `GH₵ ${(parseFloat(amount) || 0).toFixed(2)}`;
        const hideAdminLoader = () => adminLoader.classList.remove('active');
        const showAdminLoader = () => adminLoader.classList.add('active');

        // [UPDATED] timeSince function for manual top-ups
        const timeSince = (date) => {
            if (!date) return 'N/A';
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        };
        // Helper to format category names
        const formatCategoryName = (name) => name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        // ===================================================================================
        // AUTHENTICATION
        // ===================================================================================
        const initializeAdminPanel = async () => {
            adminLoginWrapper.style.display = 'none';
            adminPanelContainer.style.display = 'flex';
            if (window.innerWidth > 768) {
                document.body.classList.add('admin-sidebar-open');
                adminSidebar.classList.add('active');
            }
            
            showAdminLoader();
            try {
                await loadAllUsersForCache();
                await Promise.all([loadDashboardStats(), loadRecentOrders()]);
            } catch (error) {
                console.error("Failed to initialize admin dashboard:", error);
                showToast("Error loading dashboard data.", 'error');
            } finally {
                hideAdminLoader();
            }
        };
        
        onAuthStateChanged(auth, (user) => {
            if (user && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                initializeAdminPanel();
            } else {
                adminPanelContainer.style.display = 'none';
                adminLoginWrapper.style.display = 'flex';
                hideAdminLoader();
            }
        });

        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminLoginEmail').value;
            const password = document.getElementById('adminLoginPassword').value;
            const loginBtn = document.getElementById('adminLoginBtn');
            toggleButtonLoading(loginBtn, true);

            if (email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                showToast('Access Denied', 'error', 'This email is not authorized for admin access.');
                toggleButtonLoading(loginBtn, false);
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showToast('Login Failed', 'error', error.message);
            } finally {
                toggleButtonLoading(loginBtn, false);
            }
        });

        adminLogoutBtn.addEventListener('click', async () => await signOut(auth));

        // ===================================================================================
        // SIDEBAR NAVIGATION
        // ===================================================================================
        const closeAdminSidebar = () => {
            adminSidebar.classList.remove('active');
            adminSidebarOverlay.classList.remove('active');
            if (window.innerWidth > 768) {
                 document.body.classList.remove('admin-sidebar-open');
            }
        };

        adminMenuToggle.addEventListener('click', () => {
            adminSidebar.classList.toggle('active');
            adminSidebarOverlay.classList.toggle('active');
            if (window.innerWidth > 768) {
                document.body.classList.toggle('admin-sidebar-open');
            }
        });

        adminSidebarOverlay.addEventListener('click', closeAdminSidebar);
        
        adminNavLinks.forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                const targetId = link.dataset.target;
                document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
                adminPageTopBarTitle.textContent = link.textContent.trim();
                
                showAdminLoader();
                try {
                    switch (targetId) {
                        case 'adminDashboardTab': await Promise.all([loadDashboardStats(), loadRecentOrders()]); break;
                        case 'manageUsersTab': renderUsersFromCache(); break;
                        case 'packageManagerTab': await loadPackages(); break;
                        case 'manageOrdersTab': await loadOrders(); break;
                        case 'storesTab': await loadStores(); break;
                        case 'storeOrdersTab': await loadStoreOrders(); break;
                        case 'storePayoutsTab': await loadStorePayouts(); break;
                        case 'onlineCoursesTab': await loadOnlineCourses(); break;
                        case 'coursePurchasesTab': await loadCoursePurchases(); break;
                        case 'manageAfaRegistrationsTab': await loadAfaRegistrations(); break;
                        // REMOVED: Manual top-ups feature no longer used
                        // case 'manualTopUpsTab': await loadManualTopUps(); break;
                        case 'marketplaceBannersTab': await loadMarketplaceBanners(); break;
                        case 'marketplaceCategoriesTab': await loadMarketplaceCategories(); break;
                        case 'marketplaceProductsTab': await loadMarketplaceProducts(); break;
                        case 'websiteQueueTab': await loadWebsiteQueue(); break;
                        case 'notificationsTab': await loadNotifications(); break;
                        case 'controlsTab': await loadSiteSettings(); break;
                    }
                } catch(error) {
                    console.error(`Failed to load tab ${targetId}:`, error);
                    showToast('Failed to load page data.', 'error');
                } finally {
                    hideAdminLoader();
                }
                
                if (window.innerWidth < 769) closeAdminSidebar();
            });
        });

        // ===================================================================================
        // DATA CACHING & DASHBOARD
        // ===================================================================================
        const loadAllUsersForCache = async () => {
            const snapshot = await getDocs(collection(db, "users"));
            allUsersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        };
        const findUserInCache = (userId) => allUsersCache.find(user => user.id === userId);

        const loadDashboardStats = async () => {
            try {
                const ordersSnapshot = await getDocs(collection(db, "orders"));

                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);

                let totalRevenue = 0;
                let ordersTodayCount = 0;

                // Process all orders once - filter in JavaScript to avoid index requirement
                ordersSnapshot.docs.forEach(doc => {
                    const orderData = doc.data();

                    // Count revenue from completed orders
                    if (orderData.status === 'completed') {
                        totalRevenue += parseFloat(orderData.amount || 0);
                    }

                    // Count today's orders
                    if (orderData.createdAt) {
                        const orderDate = orderData.createdAt.toDate ? orderData.createdAt.toDate() : new Date(orderData.createdAt);
                        if (orderDate >= todayStart) {
                            ordersTodayCount++;
                        }
                    }
                });

                const totalUserBalance = allUsersCache.reduce((sum, user) => sum + (parseFloat(user.balance || user.walletBalance) || 0), 0);

                document.getElementById('adminStatTotalRevenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('adminStatTotalUsers').textContent = allUsersCache.length;
                document.getElementById('adminStatTotalOrders').textContent = ordersSnapshot.size;
                document.getElementById('adminStatOrdersToday').textContent = ordersTodayCount;
                document.getElementById('adminStatTotalUserBalance').textContent = formatCurrency(totalUserBalance);

            } catch (error) {
                 console.error("Error loading dashboard stats:", error);
                 showToast('Could not load stats', 'error');
            }
        };

        const loadRecentOrders = async () => {
             try {
                const q = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(10));
                const snapshot = await getDocs(q);
                const tbody = document.getElementById('adminRecentOrdersTableBody');
                tbody.innerHTML = '';
                document.getElementById('noRecentOrdersPlaceholder').style.display = snapshot.empty ? 'block' : 'none';
                if(snapshot.empty) return;

                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    const user = findUserInCache(order.userId);
                    tbody.innerHTML += `
                        <tr>
                            <td>${order.id.slice(0, 8).toUpperCase()}</td>
                            <td>${user?.email || 'N/A'}</td>
                            <td>${order.details?.package || 'AFA Reg'} for ${order.details?.phone || 'N/A'}</td>
                            <td>${formatCurrency(order.amount)}</td>
                            <td><span class="status-badge ${order.status.toLowerCase()}">${order.status}</span></td>
                            <td>${formatDate(order.createdAt)}</td>
                        </tr>`;
                });
             } catch (error) {
                 console.error("Error loading recent orders:", error);
                 showToast('Could not load recent orders', 'error');
             }
        };

        // ===================================================================================
        // USER MANAGEMENT
        // ===================================================================================
        const renderUsersFromCache = () => {
            const searchTerm = document.getElementById('adminUserSearch').value.toLowerCase();
            const roleFilter = document.getElementById('adminUserRoleFilter').value;
            const tbody = document.getElementById('adminUsersTableBody');
            tbody.innerHTML = '';

            const filteredUsers = allUsersCache.filter(user => {
                let userRole = 'customer';
                if (user.isGoldenActivated) userRole = 'agent';
                if (user.isMerchant) userRole = 'merchant'; // Prioritize merchant role for display

                const roleMatch = (roleFilter === 'all') || (userRole === roleFilter);
                const searchMatch = !searchTerm || 
                    (user.fullName || '').toLowerCase().includes(searchTerm) || 
                    (user.email || '').toLowerCase().includes(searchTerm) || 
                    (user.userId || '').toLowerCase().includes(searchTerm);
                return roleMatch && searchMatch;
            });
            
            document.getElementById('noAdminUsersPlaceholder').style.display = filteredUsers.length === 0 ? 'block' : 'none';

            filteredUsers.forEach(user => {
                let userRole = 'Customer';
                if (user.isGoldenActivated) userRole = 'Agent';
                if (user.isMerchant) userRole = 'Merchant'; // Prioritize merchant role for display

                const approvalStatus = user.isApproved === false ? 'Pending' : 'Approved';

                const twoFAStatus = user.twoFAEnabled ? 'Enabled' : 'Disabled';
                const twoFABadgeClass = user.twoFAEnabled ? 'completed' : 'inactive';

                // API Access toggle
                const apiAccessChecked = user.apiAccessEnabled ? 'checked' : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${user.userId || user.id || 'N/A'}</td>
                        <td>${user.fullName || user.displayName || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.mobile || user.phoneNumber || user.phone || 'N/A'}</td>
                        <td>${formatCurrency(user.balance || user.walletBalance || 0)}</td>
                        <td>${userRole}</td>
                        <td><span class="status-badge ${twoFABadgeClass}">${twoFAStatus}</span></td>
                        <td><span class="status-badge ${approvalStatus.toLowerCase()}">${approvalStatus}</span></td>
                        <td>${formatDate(user.createdAt)}</td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" class="api-access-toggle" data-userid="${user.id}" ${apiAccessChecked}>
                                <span class="slider round"></span>
                            </label>
                        </td>
                        <td><button class="action-btn edit-btn" data-userid="${user.id}">Edit</button></td>
                    </tr>`;
            });
        };

        document.getElementById('adminUsersTableBody').addEventListener('click', async (e) => {
            if (e.target.closest('.edit-btn')) {
                const userId = e.target.closest('.edit-btn').dataset.userid;
                const user = findUserInCache(userId);
                if (user) {
                    document.getElementById('adminEditUserId').value = user.id;
                    document.getElementById('adminEditUserEmail').textContent = user.email || 'N/A';
                    document.getElementById('adminEditUserName').value = user.fullName || user.displayName || '';
                    document.getElementById('adminEditUserPhone').value = user.mobile || user.phoneNumber || user.phone || '';
                    document.getElementById('adminEditUserWalletBalance').value = ((user.balance || user.walletBalance) || 0).toFixed(2);
                    document.getElementById('adminEditUserIsApproved').checked = user.isApproved !== false;
                    document.getElementById('adminEditUserIsAgent').checked = user.isGoldenActivated || false;
                    document.getElementById('adminEditUser2FAEnabled').checked = user.twoFAEnabled || false;
                    document.getElementById('adminEditUser2FAPhone').value = user.twoFAPhone || '';
                    openModal('userEditModal');
                }
            }
        });

        document.getElementById('adminEditUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = document.getElementById('adminSaveUserChangesBtn');
            toggleButtonLoading(button, true);
            const userId = document.getElementById('adminEditUserId').value;
            try {
                const phoneValue = document.getElementById('adminEditUserPhone').value;
                const isAgentEnabled = document.getElementById('adminEditUserIsAgent').checked;
                const currentUser = allUsersCache.find(u => u.id === userId);

                const updates = {
                    fullName: document.getElementById('adminEditUserName').value,
                    mobile: phoneValue, // Use 'mobile' as the primary field
                    phoneNumber: phoneValue, // Also update phoneNumber for compatibility
                    balance: parseFloat(document.getElementById('adminEditUserWalletBalance').value),
                    isApproved: document.getElementById('adminEditUserIsApproved').checked,
                    isGoldenActivated: isAgentEnabled,
                    twoFAEnabled: document.getElementById('adminEditUser2FAEnabled').checked,
                    twoFAPhone: document.getElementById('adminEditUser2FAPhone').value || null,
                };

                // If Golden Ticket is being enabled, set role to Agent
                if (isAgentEnabled && !currentUser?.isGoldenActivated) {
                    updates.role = 'Agent';
                    updates.goldenTicketStatus = 'activated';
                    updates.goldenTicketPurchasedAt = serverTimestamp();
                }
                // If Golden Ticket is being disabled, revert role to Customer
                if (!isAgentEnabled && currentUser?.isGoldenActivated) {
                    updates.role = 'Customer';
                    updates.goldenTicketStatus = 'deactivated';
                }

                // If 2FA is being enabled, also set the timestamp
                if (updates.twoFAEnabled && !currentUser?.twoFAEnabled) {
                    updates.twoFAEnabledAt = serverTimestamp();
                }
                // If 2FA is being disabled, set disabled timestamp
                if (!updates.twoFAEnabled && currentUser?.twoFAEnabled) {
                    updates.twoFADisabledAt = serverTimestamp();
                }
                await updateDoc(doc(db, "users", userId), updates);
                
                const userIndex = allUsersCache.findIndex(u => u.id === userId);
                if(userIndex > -1) allUsersCache[userIndex] = {...allUsersCache[userIndex], ...updates};

                closeModal('userEditModal');
                showToast('User updated successfully!', 'success');
                renderUsersFromCache();
            } catch (error) {
                 showToast('Update failed: ' + error.message, 'error');
            } finally {
                toggleButtonLoading(button, false);
            }
        });
        
        document.getElementById('adminUserSearch').addEventListener('input', renderUsersFromCache);
        document.getElementById('adminUserRoleFilter').addEventListener('change', renderUsersFromCache);

        // API Access toggle event handler
        document.getElementById('adminUsersTableBody').addEventListener('change', async (e) => {
            if (e.target.classList.contains('api-access-toggle')) {
                const userId = e.target.dataset.userid;
                const enabled = e.target.checked;
                try {
                    await updateDoc(doc(db, "users", userId), { apiAccessEnabled: enabled });
                    // Update cache
                    const userIndex = allUsersCache.findIndex(u => u.id === userId);
                    if (userIndex > -1) allUsersCache[userIndex].apiAccessEnabled = enabled;
                    showToast(`API Access ${enabled ? 'enabled' : 'disabled'} for user`, 'success');
                } catch (error) {
                    showToast('Failed to update API Access: ' + error.message, 'error');
                    // Revert toggle on error
                    e.target.checked = !enabled;
                }
            }
        });
        
        // ===================================================================================
        // PACKAGE MANAGEMENT
        // ===================================================================================
        const loadPackages = async () => {
            const container = document.getElementById('packagesCategorizedContainer');
            container.innerHTML = '';
            const noDataPlaceholder = document.getElementById('noPackagesPlaceholder');

            try {
                const networks = ['mtn', 'telecel', 'at'];
                let hasPackages = false;

                for (const network of networks) {
                    const packagesRef = collection(db, `dataPackages/${network}/packages`);
                    const snapshot = await getDocs(packagesRef);

                    if (!snapshot.empty) {
                        hasPackages = true;
                        const networkDisplay = network.toUpperCase();

                        const categoryContainer = document.createElement('div');
                        categoryContainer.className = 'package-category-container';
                        const header = document.createElement('h4');
                        header.className = 'package-category-header';
                        header.textContent = `${networkDisplay} Packages`;
                        categoryContainer.appendChild(header);

                        const tableWrapper = document.createElement('div');
                        tableWrapper.className = 'admin-table-wrapper';
                        const table = document.createElement('table');
                        table.className = 'admin-table';
                        table.innerHTML = `<thead><tr><th>Name</th><th>Data Size</th><th>Validity</th><th>Customer Price</th><th>Agent Price</th><th>Status</th><th>Actions</th></tr></thead>`;
                        const tbody = document.createElement('tbody');

                        snapshot.forEach(doc => {
                            const pkg = { id: doc.id, network, ...doc.data() };
                            const statusBadge = pkg.isActive ? 'active' : 'inactive';
                            tbody.innerHTML += `
                                <tr>
                                    <td>${pkg.name || pkg.packageName || 'N/A'}</td>
                                    <td>${pkg.dataSize || 'N/A'}</td>
                                    <td>${pkg.validity || 'N/A'}</td>
                                    <td>GH₵ ${(pkg.customerPrice || 0).toFixed(2)}</td>
                                    <td>GH₵ ${(pkg.agentPrice || pkg.customerPrice || 0).toFixed(2)}</td>
                                    <td><span class="status-badge ${statusBadge}">${pkg.isActive ? 'Active' : 'Inactive'}</span></td>
                                    <td>
                                        <button class="action-btn edit-btn" data-pkgid="${pkg.id}" data-network="${network}"><i class="fas fa-edit"></i> Edit</button>
                                        <button class="action-btn delete-btn" data-pkgid="${pkg.id}" data-network="${network}"><i class="fas fa-trash"></i> Delete</button>
                                    </td>
                                </tr>`;
                        });

                        table.appendChild(tbody);
                        tableWrapper.appendChild(table);
                        categoryContainer.appendChild(tableWrapper);
                        container.appendChild(categoryContainer);
                    }
                }

                noDataPlaceholder.style.display = hasPackages ? 'none' : 'block';
                container.style.display = hasPackages ? 'block' : 'none';
            } catch (error) {
                console.error("Error loading packages:", error);
                showToast('Failed to load packages', 'error');
            }
        };

        document.getElementById('addNewPackageBtn').addEventListener('click', () => {
            currentEditingPackageId = null;
            currentEditingPackageNetwork = null; // ✅ Reset network
            document.getElementById('packageForm').reset();
            document.getElementById('packageId').value = '';
            document.getElementById('packageNetwork').value = "";
            document.getElementById('packageModalTitle').textContent = 'Add New Package';
            document.getElementById('packageIsActive').checked = true;
            openModal('packageEditModal');
        });
        
        document.getElementById('packagesCategorizedContainer').addEventListener('click', async (e) => {
            const target = e.target.closest('.action-btn');
            if(!target) return;
            const packageId = target.dataset.pkgid;
            const network = target.dataset.network; // ✅ Get network from button

            if (target.classList.contains('edit-btn')) {
                currentEditingPackageId = packageId;
                currentEditingPackageNetwork = network; // ✅ Store network
                const pkgDoc = await getDoc(doc(db, `dataPackages/${network}/packages`, packageId));
                if (pkgDoc.exists()) {
                    const pkg = pkgDoc.data();
                    document.getElementById('packageId').value = packageId;
                    document.getElementById('packageNetwork').value = network;
                    document.getElementById('packageName').value = pkg.name || pkg.packageName || '';
                    document.getElementById('packageDataSize').value = pkg.dataSize || '';
                    document.getElementById('packageValidity').value = pkg.validity || '';
                    document.getElementById('packageDescription').value = pkg.description || '';
                    document.getElementById('packageCustomerPrice').value = pkg.customerPrice;
                    document.getElementById('packageAgentPrice').value = pkg.agentPrice;
                    document.getElementById('packageIsActive').checked = pkg.isActive;
                    document.getElementById('packageModalTitle').textContent = 'Edit Package';
                    openModal('packageEditModal');
                }
            } else if (target.classList.contains('delete-btn')) {
                const result = await Swal.fire({ title: "Are you sure?", text: "This package will be permanently deleted.", icon: "warning", showCancelButton: true, confirmButtonColor: "#e74c3c", cancelButtonColor: '#7f8c8d', confirmButtonText: "Yes, delete it!" });
                if (result.isConfirmed) {
                    await deleteDoc(doc(db, `dataPackages/${network}/packages`, packageId));
                    showToast('Package deleted!', 'success');
                    await loadPackages();
                }
            }
        });

        document.getElementById('packageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = document.getElementById('savePackageBtn');
            toggleButtonLoading(button, true);

            const network = document.getElementById('packageNetwork').value;

            // Validate network selection
            if (!network) {
                showToast('Please select a network', 'error');
                toggleButtonLoading(button, false);
                return;
            }

            const packageData = {
                network: network,
                name: document.getElementById('packageName').value, // ✅ Use 'name' field
                packageName: document.getElementById('packageName').value, // Keep for backward compatibility
                dataSize: document.getElementById('packageDataSize').value || '',
                validity: document.getElementById('packageValidity').value || '',
                description: document.getElementById('packageDescription').value || '',
                customerPrice: parseFloat(document.getElementById('packageCustomerPrice').value),
                agentPrice: parseFloat(document.getElementById('packageAgentPrice').value),
                isActive: document.getElementById('packageIsActive').checked
            };

            try {
                // ✅ Save to correct subcollection: dataPackages/{network}/packages
                if (currentEditingPackageId && currentEditingPackageNetwork) {
                    // Update existing package
                    await updateDoc(doc(db, `dataPackages/${currentEditingPackageNetwork}/packages`, currentEditingPackageId), packageData);
                } else {
                    // Add new package
                    await addDoc(collection(db, `dataPackages/${network}/packages`), packageData);
                }
                closeModal('packageEditModal');
                showToast('Package saved successfully!', 'success');
                await loadPackages();
            } catch (error) {
                console.error('Save package error:', error);
                showToast('Save failed: ' + error.message, 'error');
            } finally {
                currentEditingPackageId = null;
                currentEditingPackageNetwork = null; // ✅ Reset network
                toggleButtonLoading(button, false);
            }
        });

        // ===================================================================================
        // CUSTOMER ORDERS MANAGEMENT [UPDATED WITH BULK ACTIONS]
        // ===================================================================================
        const loadOrders = async () => {
             const searchTerm = document.getElementById('adminOrderUserSearch').value.toLowerCase();
             const statusFilter = document.getElementById('adminOrderStatusFilter').value;
             const tbody = document.getElementById('adminOrdersTableBody');
             tbody.innerHTML = '';

             let ordersQuery = query(collection(db, "orders"));
             if (statusFilter !== 'all') {
                 ordersQuery = query(ordersQuery, where("status", "==", statusFilter));
             }
             ordersQuery = query(ordersQuery, orderBy("createdAt", "desc"));
             
             const snapshot = await getDocs(ordersQuery);
             let orders = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
             
             const filteredOrders = orders.filter(order => {
                const user = findUserInCache(order.userId);
                const searchMatch = !searchTerm || (user && ((user.email || '').toLowerCase().includes(searchTerm) || (user.fullName || '').toLowerCase().includes(searchTerm) ||(user.userId || '').toLowerCase().includes(searchTerm)));
                return searchMatch;
             });

             document.getElementById('noAdminOrdersPlaceholder').style.display = filteredOrders.length === 0 ? 'block' : 'none';
             filteredOrders.forEach(order => {
                const user = findUserInCache(order.userId);

                // Determine order type display
                let orderTypeDisplay = 'Data Bundle';
                if (order.orderType === 'afa_registration') orderTypeDisplay = 'AFA Registration';
                else if (order.orderType === 'results_checker') orderTypeDisplay = `${order.checkerType || 'Results'} Checker`;
                else if (order.orderType === 'mtnjust4u') orderTypeDisplay = 'MTN Just4U';
                else if (order.orderType === 'afa_mins') orderTypeDisplay = 'AFA Minutes';

                // Get package/order details
                const packageDetails = order.name || order.details?.package || orderTypeDisplay;
                // Prefer phone fields and convert international format to local 0XXXXXXXXX for display
                const rawPhone = order.phone || order.details?.phone || order.details?.recipientPhone || order.details?.fullName || order.afaFullName || '';
                const recipientInfo = rawPhone ? intlToLocal(rawPhone) : 'N/A';

                // Use displayOrderId if available, otherwise fallback to doc id
                const displayId = order.displayOrderId || order.id.slice(0, 8).toUpperCase();

                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="order-checkbox" data-order-id="${order.id}"></td>
                        <td>${displayId}</td>
                        <td>${user?.email || 'N/A'}</td>
                        <td>${packageDetails} for ${recipientInfo}</td>
                        <td>${formatCurrency(order.amount)}</td>
                        <td><span class="status-badge ${order.status.toLowerCase()}">${order.status}</span></td>
                        <td>${formatDate(order.createdAt)}</td>
                        <td><button class="action-btn view-btn" data-orderid="${order.id}">View/Update</button></td>
                    </tr>`;
             });
             toggleBulkActionsVisibility(); // Update bulk actions visibility after loading orders
        };
        document.getElementById('adminOrderUserSearch').addEventListener('input', loadOrders);
        document.getElementById('adminOrderStatusFilter').addEventListener('change', loadOrders);

        document.getElementById('adminOrdersTableBody').addEventListener('click', async (e) => {
            if (e.target.closest('.view-btn')) {
                currentEditingOrderId = e.target.closest('.view-btn').dataset.orderid;
                const orderDoc = await getDoc(doc(db, "orders", currentEditingOrderId));
                    if (orderDoc.exists()) {
                    const order = orderDoc.data();
                    const user = findUserInCache(order.userId);
                    const detailPhoneRaw = order.details?.phone || order.phone || order.details?.recipientPhone || '';
                    const detailPhone = detailPhoneRaw ? intlToLocal(detailPhoneRaw) : 'N/A';
                    document.getElementById('orderDetailsContent').innerHTML = `
                        <div class="info-readonly-group"><strong>User Email:</strong><p>${user?.email || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Phone Number:</strong><p>${detailPhone}</p></div>
                        <div class="info-readonly-group"><strong>Package:</strong><p>${order.details?.package || order.name || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Amount:</strong><p>${formatCurrency(order.amount)}</p></div>`;
                    document.getElementById('orderUpdateStatusSelect').value = order.status.toLowerCase();
                    openModal('orderUpdateModal');
                }
            }
        });

        document.getElementById('confirmUpdateOrderStatusBtn').addEventListener('click', async () => {
            if (!currentEditingOrderId) return;
            const button = document.getElementById('confirmUpdateOrderStatusBtn');
            toggleButtonLoading(button, true);
            try {
                const newStatus = document.getElementById('orderUpdateStatusSelect').value;
                await updateDoc(doc(db, "orders", currentEditingOrderId), { status: newStatus });
                showToast('Order Status Updated!', 'success');
                closeModal('orderUpdateModal');
                await loadOrders();
            } catch (error) {
                showToast('Update failed.', 'error');
            } finally {
                toggleButtonLoading(button, false);
                currentEditingOrderId = null;
            }
        });

        // --- [NEW] Bulk Order Update Logic ---
        const toggleBulkActionsVisibility = () => {
            const selectedCount = document.querySelectorAll('#adminOrdersTableBody .order-checkbox:checked').length;
            const bulkActionsBar = document.getElementById('bulkOrderActions');
            bulkActionsBar.style.display = selectedCount > 0 ? 'block' : 'none';
        };

        document.getElementById('selectAllOrdersCheckbox').addEventListener('change', (e) => {
            document.querySelectorAll('#adminOrdersTableBody .order-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            toggleBulkActionsVisibility();
        });

        document.getElementById('adminOrdersTableBody').addEventListener('change', (e) => {
            if (e.target.classList.contains('order-checkbox')) {
                toggleBulkActionsVisibility();
            }
        });

        document.getElementById('applyBulkUpdateBtn').addEventListener('click', async () => {
            const selectedCheckboxes = document.querySelectorAll('#adminOrdersTableBody .order-checkbox:checked');
            const newStatus = document.getElementById('bulkOrderStatusUpdate').value;

            if (selectedCheckboxes.length === 0) return showToast('No orders selected', 'warning');
            if (!newStatus) return showToast('Please select a status to apply', 'warning');

            const orderIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.orderId);

            const { isConfirmed } = await Swal.fire({
                title: 'Confirm Bulk Update',
                html: `Are you sure you want to change <strong>${orderIds.length}</strong> order(s) to <strong>${newStatus}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, update them!'
            });

            if (isConfirmed) {
                showAdminLoader();
                try {
                    const batch = writeBatch(db);
                    orderIds.forEach(orderId => {
                        batch.update(doc(db, 'orders', orderId), { status: newStatus });
                    });
                    await batch.commit();
                    showToast(`${orderIds.length} orders updated successfully!`, 'success');
                    await loadOrders(); // Refresh the view
                    document.getElementById('selectAllOrdersCheckbox').checked = false;
                    toggleBulkActionsVisibility();
                } catch (error) {
                    console.error("Bulk update failed:", error);
                    showToast('Bulk update failed', 'error', error.message);
                } finally {
                    hideAdminLoader();
                }
            }
        });
        
        // ===================================================================================
        // STORES & MERCHANT MANAGEMENT
        // ===================================================================================

        const loadStores = async () => {
            const searchTerm = document.getElementById('storeSearch').value.toLowerCase();
            const approvalFilter = document.getElementById('storeApprovalFilter').value;
            const banFilter = document.getElementById('storeBanFilter').value;
            const tbody = document.getElementById('storesTableBody');
            tbody.innerHTML = '';

            const storesSnapshot = await getDocs(query(collection(db, "stores"), orderBy("brandName")));
            let stores = storesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

            const filteredStores = stores.filter(store => {
                const owner = findUserInCache(store.ownerId);
                const isApproved = owner?.isApproved !== false; // Assuming 'isApproved' means approved if true or missing
                
                const searchMatch = !searchTerm ||
                    (store.brandName || '').toLowerCase().includes(searchTerm) ||
                    (store.slug || '').toLowerCase().includes(searchTerm) ||
                    (owner && (owner.email || '').toLowerCase().includes(searchTerm));
                
                const approvalMatch = approvalFilter === 'all' || (approvalFilter === 'approved' && isApproved) || (approvalFilter === 'pending' && !isApproved);
                const banMatch = banFilter === 'all' || (banFilter === 'banned' && store.isBanned) || (banFilter === 'active' && !store.isBanned);

                return searchMatch && approvalMatch && banMatch;
            });

            document.getElementById('noStoresPlaceholder').style.display = filteredStores.length === 0 ? 'block' : 'none';

            filteredStores.forEach(store => {
                const owner = findUserInCache(store.ownerId);
                const banStatus = store.isBanned ? 'Banned' : 'Active';
                const approvalStatus = owner?.isApproved === false ? 'Pending' : 'Approved'; // Display approval status

                tbody.innerHTML += `
                    <tr>
                        <td>${store.brandName || 'N/A'}</td>
                        <td>${store.slug || 'N/A'}</td>
                        <td>${owner?.email || 'N/A'}</td>
                        <td><span class="status-badge ${approvalStatus.toLowerCase()}">${approvalStatus}</span></td>
                        <td><span class="status-badge ${banStatus.toLowerCase()}">${banStatus}</span></td>
                        <td>
                            ${store.isBanned
                                ? `<button class="action-btn approve-btn unban-store-btn" data-storeid="${store.id}">Unban</button>`
                                : `<button class="action-btn reject-btn ban-store-btn" data-storeid="${store.id}">Ban</button>`
                            }
                        </td>
                    </tr>`;
            });
        };
        document.getElementById('storeSearch').addEventListener('input', loadStores);
        document.getElementById('storeApprovalFilter').addEventListener('change', loadStores);
        document.getElementById('storeBanFilter').addEventListener('change', loadStores);

        document.getElementById('storesTableBody').addEventListener('click', async (e) => {
            const target = e.target.closest('.action-btn');
            if (!target) return;

            const storeId = target.dataset.storeid;
            const shouldBan = target.classList.contains('ban-store-btn');
            
            const { isConfirmed } = await Swal.fire({
                title: `${shouldBan ? 'Ban' : 'Unban'} this store?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `Yes, ${shouldBan ? 'Ban' : 'Unban'} it!`,
                confirmButtonColor: shouldBan ? '#e74c3c' : '#27ae60'
            });

            if (isConfirmed) {
                showAdminLoader();
                try {
                    await updateDoc(doc(db, 'stores', storeId), { isBanned: shouldBan });
                    showToast(`Store has been ${shouldBan ? 'banned' : 'unbanned'}!`, 'success');
                    await loadStores(); // Refresh the list
                } catch (error) {
                    showToast('Operation Failed', 'error', error.message);
                } finally {
                    hideAdminLoader();
                }
            }
        });


        const loadStoreOrders = async () => {
            const searchTerm = document.getElementById('adminStoreOrderSearch').value.toLowerCase();
            const statusFilter = document.getElementById('adminStoreOrderStatusFilter').value;
            const tbody = document.getElementById('storeOrdersTableBody');
            tbody.innerHTML = '';

            try {
                let ordersQuery = query(collection(db, "storeOrders"), orderBy("createdAt", "desc"), limit(100));
                if (statusFilter !== 'all') {
                    ordersQuery = query(collection(db, "storeOrders"), where("status", "==", statusFilter.toLowerCase()), orderBy("createdAt", "desc"), limit(100));
                }

                const snapshot = await getDocs(ordersQuery);
                let orders = snapshot.docs.map(d => ({id: d.id, ...d.data()}));

                const filteredOrders = orders.filter(order => {
                    const merchant = findUserInCache(order.merchantId);
                    return !searchTerm || (
                        (order.storeName || '').toLowerCase().includes(searchTerm) ||
                        (merchant && ((merchant.email || '').toLowerCase().includes(searchTerm) || (merchant.fullName || '').toLowerCase().includes(searchTerm)))
                    );
                });

                document.getElementById('noStoreOrdersPlaceholder').style.display = filteredOrders.length === 0 ? 'block' : 'none';

                filteredOrders.forEach(order => {
                    const merchant = findUserInCache(order.merchantId);
                    const statusLower = (order.status || 'pending').toLowerCase();
                    tbody.innerHTML += `
                        <tr>
                            <td>${order.id.slice(0, 8).toUpperCase()}</td>
                            <td>${order.storeName || merchant?.email || 'N/A'}</td>
                            <td>${order.customerPhone || 'N/A'}</td>
                            <td>${order.productName || 'N/A'} (${order.packageSize || ''})</td>
                            <td>GH₵ ${(order.profit || 0).toFixed(2)}</td>
                            <td><span class="status-badge ${statusLower}">${order.status || 'Pending'}</span></td>
                            <td>${formatDate(order.createdAt)}</td>
                            <td><button class="action-btn view-btn" data-orderid="${order.id}">View</button></td>
                        </tr>`;
                });
            } catch (error) {
                console.error("Error loading store orders:", error);
                showToast('Failed to load store orders', 'error');
            }
        };
        document.getElementById('adminStoreOrderSearch').addEventListener('input', loadStoreOrders);
        document.getElementById('adminStoreOrderStatusFilter').addEventListener('change', loadStoreOrders);

        document.getElementById('storeOrdersTableBody').addEventListener('click', async (e) => {
            if (e.target.closest('.view-btn')) {
                currentEditingStoreOrderId = e.target.closest('.view-btn').dataset.orderid;
                const orderDoc = await getDoc(doc(db, "storeOrders", currentEditingStoreOrderId));
                if (orderDoc.exists()) {
                    const order = orderDoc.data();
                    const merchant = findUserInCache(order.merchantId);
                    document.getElementById('storeOrderDetailsContent').innerHTML = `
                        <div class="info-readonly-group"><strong>Store Name:</strong><p>${order.storeName || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Merchant:</strong><p>${merchant?.email || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Product:</strong><p>${order.productName || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Package Size:</strong><p>${order.packageSize || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Network:</strong><p>${(order.productNetwork || 'N/A').toUpperCase()}</p></div>
                        <div class="info-readonly-group"><strong>Customer Phone:</strong><p>${order.customerPhone || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Beneficiary Number:</strong><p>${order.beneficiaryNumber || order.customerPhone || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Selling Price:</strong><p>GH₵ ${(order.sellingPrice || 0).toFixed(2)}</p></div>
                        <div class="info-readonly-group"><strong>Cost Price:</strong><p>GH₵ ${(order.costPrice || 0).toFixed(2)}</p></div>
                        <div class="info-readonly-group"><strong>Profit:</strong><p>GH₵ ${(order.profit || 0).toFixed(2)}</p></div>
                        <div class="info-readonly-group"><strong>Payment Status:</strong><p>${order.paymentStatus || 'N/A'}</p></div>`;
                    document.getElementById('storeOrderUpdateStatusSelect').value = order.status || 'pending';
                    openModal('storeOrderUpdateModal');
                }
            }
        });

        document.getElementById('confirmUpdateStoreOrderStatusBtn').addEventListener('click', async () => {
            if (!currentEditingStoreOrderId) return;
            const button = document.getElementById('confirmUpdateStoreOrderStatusBtn');
            toggleButtonLoading(button, true);
            try {
                const newStatus = document.getElementById('storeOrderUpdateStatusSelect').value;
                await updateDoc(doc(db, "storeOrders", currentEditingStoreOrderId), { status: newStatus });
                showToast('Store Order Status Updated!', 'success');
                closeModal('storeOrderUpdateModal');
                await loadStoreOrders();
            } catch (error) {
                showToast('Update failed: ' + error.message, 'error');
            } finally {
                toggleButtonLoading(button, false);
                currentEditingStoreOrderId = null;
            }
        });

        const loadStorePayouts = async () => {
            const statusFilter = document.getElementById('adminPayoutStatusFilter').value;
            const tbody = document.getElementById('storePayoutsTableBody');
            tbody.innerHTML = '';

            let payoutsQuery = query(collection(db, "payoutRequests"));
             if (statusFilter !== 'all') {
                payoutsQuery = query(payoutsQuery, where("status", "==", statusFilter));
            }
            payoutsQuery = query(payoutsQuery, orderBy("requestedAt", "desc"));

            const snapshot = await getDocs(payoutsQuery);
            document.getElementById('noStorePayoutsPlaceholder').style.display = snapshot.empty ? 'block' : 'none';

            snapshot.docs.forEach(d => {
                const payout = {id: d.id, ...d.data()};
                const merchant = findUserInCache(payout.merchantId);
                tbody.innerHTML += `
                    <tr>
                        <td>${payout.id.slice(0, 8).toUpperCase()}</td>
                        <td>${payout.merchantEmail || merchant?.email || 'N/A'}</td>
                        <td>${formatCurrency(payout.amount)}</td>
                        <td>${payout.momoName || 'N/A'}</td>
                        <td>${payout.momoPhone || 'N/A'}</td>
                        <td>${payout.momoNetwork || 'N/A'}</td>
                        <td><span class="status-badge ${payout.status.toLowerCase()}">${payout.status}</span></td>
                        <td>${formatDate(payout.requestedAt)}</td>
                        <td>
                            ${payout.status === 'pending' ? `<button class="action-btn view-btn" data-payoutid="${payout.id}">Process</button>` : 'Processed'}
                        </td>
                    </tr>
                `;
            });
        };
        document.getElementById('adminPayoutStatusFilter').addEventListener('change', loadStorePayouts);
        
        document.getElementById('storePayoutsTableBody').addEventListener('click', async (e) => {
             if (e.target.closest('.view-btn')) {
                currentEditingPayoutId = e.target.closest('.view-btn').dataset.payoutid;
                const payoutDoc = await getDoc(doc(db, "payoutRequests", currentEditingPayoutId));
                if(payoutDoc.exists()) {
                    const payout = payoutDoc.data();
                    const merchant = findUserInCache(payout.merchantId);
                    document.getElementById('payoutDetailsContent').innerHTML = `
                        <div class="info-readonly-group"><strong>Merchant:</strong><p>${payout.merchantEmail || merchant?.email || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Merchant Name:</strong><p>${payout.merchantName || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Amount:</strong><p>${formatCurrency(payout.amount)}</p></div>
                        <div class="info-readonly-group"><strong>MoMo Account Name:</strong><p>${payout.momoName || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>MoMo Phone Number:</strong><p>${payout.momoPhone || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>MoMo Network:</strong><p>${payout.momoNetwork || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Status:</strong><p><span class="status-badge ${payout.status.toLowerCase()}">${payout.status}</span></p></div>
                        <div class="info-readonly-group"><strong>Requested:</strong><p>${formatDate(payout.requestedAt)}</p></div>
                    `;
                    openModal('payoutUpdateModal');
                }
             }
        });

        const processPayout = async (action) => {
            if (!currentEditingPayoutId) return;
            const payoutRef = doc(db, "payoutRequests", currentEditingPayoutId);
            const payoutDoc = await getDoc(payoutRef);
            if (!payoutDoc.exists()) {
                showToast("Payout request not found.", 'error');
                return;
            }

            const payoutData = payoutDoc.data();
            const merchantRef = doc(db, "users", payoutData.merchantId);
            showAdminLoader();
            try {
                if (action === 'approve') {
                    const batch = writeBatch(db);
                    // Update payout request status
                    batch.update(payoutRef, {
                        status: 'paid',
                        paidAt: serverTimestamp()
                    });
                    // Update merchant stats
                    batch.update(merchantRef, {
                        'storeMetrics.pendingPayouts': increment(-payoutData.amount),
                        'storeMetrics.totalPayouts': increment(payoutData.amount)
                    });
                    await batch.commit();
                    showToast('Payout marked as Paid!', 'success');
                } else if (action === 'reject') {
                    const batch = writeBatch(db);
                    batch.update(payoutRef, {
                        status: 'rejected',
                        rejectedAt: serverTimestamp()
                    });
                    // Return funds to merchant's available balance
                    batch.update(merchantRef, {
                        'storeMetrics.availableForPayout': increment(payoutData.amount),
                        'storeMetrics.pendingPayouts': increment(-payoutData.amount)
                    });
                    await batch.commit();
                    showToast('Payout rejected and funds returned to merchant.', 'info');
                }
                closeModal('payoutUpdateModal');
                await loadStorePayouts();
            } catch(error) {
                showToast('Operation Failed: ' + error.message, 'error');
            } finally {
                hideAdminLoader();
                currentEditingPayoutId = null;
            }
        };
        
        document.getElementById('approvePayoutBtn').addEventListener('click', () => processPayout('approve'));
        document.getElementById('rejectPayoutBtn').addEventListener('click', () => processPayout('reject'));
        
        // ===================================================================================
        // ONLINE COURSES MANAGEMENT
        // ===================================================================================
        const loadOnlineCourses = async () => {
            const q = query(collection(db, "courses"), orderBy("title"));
            const snapshot = await getDocs(q);
            const tbody = document.getElementById('onlineCoursesTableBody');
            tbody.innerHTML = '';
            document.getElementById('noOnlineCoursesPlaceholder').style.display = snapshot.empty ? 'block' : 'none';
            if (snapshot.empty) return;

            snapshot.forEach(doc => {
                const course = { id: doc.id, ...doc.data() };
                const status = course.isActive !== false ? 'Active' : 'Inactive';
                tbody.innerHTML += `
                    <tr>
                        <td>${course.title || 'N/A'}</td>
                        <td>${course.category || 'N/A'}</td>
                        <td>${course.type || 'N/A'}</td>
                        <td>${course.lessons ? course.lessons.length : 0}</td>
                        <td><span class="status-badge ${status.toLowerCase()}">${status}</span></td>
                        <td>
                            <button class="action-btn edit-btn" data-courseid="${course.id}">Edit</button>
                            <button class="action-btn delete-btn" data-courseid="${course.id}">Delete</button>
                        </td>
                    </tr>`;
            });
        };

        const loadCoursePurchases = async () => {
            const q = query(
                collection(db, "shop_purchases"), 
                where("productDetails.type", "==", "Online Course"),
                orderBy("createdAt", "desc")
            );
            const snapshot = await getDocs(q);
            const tbody = document.getElementById('coursePurchasesTableBody');
            tbody.innerHTML = '';
            document.getElementById('noCoursePurchasesPlaceholder').style.display = snapshot.empty ? 'block' : 'none';
            if (snapshot.empty) return;
            
            snapshot.forEach(doc => {
                const purchase = { id: doc.id, ...doc.data() };
                const user = findUserInCache(purchase.userId);
                tbody.innerHTML += `
                    <tr>
                        <td>${purchase.id.slice(0, 8).toUpperCase()}</td>
                        <td>${user?.email || 'N/A'}</td>
                        <td>${purchase.productDetails.name || 'N/A'}</td>
                        <td>${formatCurrency(purchase.amount)}</td>
                        <td>${formatDate(purchase.createdAt)}</td>
                    </tr>`;
            });
        };

        document.getElementById('addNewCourseBtn').addEventListener('click', () => {
            currentEditingCourseId = null;
            document.getElementById('courseForm').reset();
            document.getElementById('courseId').value = '';
            document.getElementById('courseModalTitle').textContent = 'Add New Course';
            document.getElementById('courseIsActive').checked = true;
            document.getElementById('lesson-fields-container').innerHTML = '';
            addLessonField(); // Add one empty lesson field by default
            openModal('courseEditModal');
        });
        
        document.getElementById('onlineCoursesTableBody').addEventListener('click', async (e) => {
            const target = e.target.closest('.action-btn');
            if (!target) return;
            const courseId = target.dataset.courseid;
            
            if (target.classList.contains('edit-btn')) {
                currentEditingCourseId = courseId;
                const courseDoc = await getDoc(doc(db, "courses", courseId));
                if (courseDoc.exists()) {
                    const course = courseDoc.data();
                    const form = document.getElementById('courseForm');
                    form.courseId.value = courseId;
                    form.courseTitle.value = course.title || '';
                    form.courseCategory.value = course.category || '';
                    form.courseType.value = course.type || 'Free';
                    form.courseDescription.value = course.description || '';
                    form.courseThumbnailUrl.value = course.thumbnailUrl || '';
                    form.courseBadges.value = (course.badges || []).join(', ');
                    form.courseDuration.value = course.duration || '';
                    form.courseVideoUrl.value = course.videoUrl || '';
                    form.courseIsActive.checked = course.isActive !== false;
                    
                    const lessonsContainer = document.getElementById('lesson-fields-container');
                    lessonsContainer.innerHTML = '';
                    if (course.lessons && course.lessons.length > 0) {
                        course.lessons.forEach(lesson => addLessonField(lesson.lessonTitle, lesson.videoLink));
                    } else {
                        addLessonField(); // Add at least one empty field if no lessons
                    }

                    document.getElementById('courseModalTitle').textContent = 'Edit Course';
                    openModal('courseEditModal');
                }
            } else if (target.classList.contains('delete-btn')) {
                const result = await Swal.fire({ title: "Are you sure?", text: "This course will be permanently deleted.", icon: "warning", showCancelButton: true, confirmButtonColor: "#e74c3c", confirmButtonText: "Yes, delete it!" });
                if (result.isConfirmed) {
                    await deleteDoc(doc(db, "courses", courseId));
                    showToast('Course deleted!', 'success');
                    await loadOnlineCourses();
                }
            }
        });
        
        const addLessonField = (title = '', link = '') => {
            const container = document.getElementById('lesson-fields-container');
            const newField = document.createElement('div');
            newField.className = 'lesson-entry';
            newField.innerHTML = `
                <input type="text" class="form-input lesson-title-input" placeholder="Lesson Title" value="${title}" required>
                <input type="url" class="form-input lesson-link-input" placeholder="https://youtube.com/embed/..." value="${link}" required>
                <button type="button" class="remove-lesson-btn">&times;</button>
            `;
            container.appendChild(newField);
        };
        document.getElementById('add-lesson-field-btn').addEventListener('click', () => addLessonField());
        document.getElementById('lesson-fields-container').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-lesson-btn')) {
                e.target.parentElement.remove();
            }
        });

        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = document.getElementById('saveCourseBtn');
            toggleButtonLoading(button, true);

            const lessons = [];
            let allLessonsValid = true;
            document.querySelectorAll('.lesson-entry').forEach(entry => {
                const lessonTitle = entry.querySelector('.lesson-title-input').value.trim();
                const videoLink = entry.querySelector('.lesson-link-input').value.trim();
                if (lessonTitle && videoLink) {
                    lessons.push({ lessonTitle, videoLink });
                } else {
                    allLessonsValid = false;
                }
            });

            if (!allLessonsValid) {
                showToast('All lesson fields must be filled.', 'warning');
                toggleButtonLoading(button, false);
                return;
            }

            const courseData = {
                title: document.getElementById('courseTitle').value,
                category: document.getElementById('courseCategory').value,
                type: document.getElementById('courseType').value,
                description: document.getElementById('courseDescription').value,
                thumbnailUrl: document.getElementById('courseThumbnailUrl').value,
                badges: document.getElementById('courseBadges').value.split(',').map(b => b.trim()).filter(Boolean),
                duration: document.getElementById('courseDuration').value,
                videoUrl: document.getElementById('courseVideoUrl').value,
                isActive: document.getElementById('courseIsActive').checked,
                lessons: lessons,
                lastUpdated: serverTimestamp()
            };

            try {
                if (currentEditingCourseId) {
                    await updateDoc(doc(db, "courses", currentEditingCourseId), courseData);
                } else {
                    await addDoc(collection(db, "courses"), courseData);
                }
                closeModal('courseEditModal');
                showToast('Course saved successfully!', 'success');
                await loadOnlineCourses();
            } catch (error) {
                 showToast('Save failed', 'error', error.message);
            } finally {
                currentEditingCourseId = null;
                toggleButtonLoading(button, false);
            }
        });


        // ===================================================================================
        // REMOVED: MANUAL TOP-UP MANAGEMENT - Feature no longer used
        // ===================================================================================
        /*
        const loadManualTopUps = async () => {
            const searchTerm = document.getElementById('manualTopUpSearch').value.toLowerCase();
            const statusFilter = document.getElementById('manualTopUpStatusFilter').value;
            const tbody = document.getElementById('manualTopUpsTableBody');
            tbody.innerHTML = '';

            // Query both manualTopups and transactions collections
            let topUpQuery;
            if (statusFilter !== 'all') {
                topUpQuery = query(collection(db, "manualTopups"), where("status", "==", statusFilter), orderBy("createdAt", "desc"));
            } else {
                topUpQuery = query(collection(db, "manualTopups"), orderBy("createdAt", "desc"));
            }

            const snapshot = await getDocs(topUpQuery);
            let requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const filteredRequests = requests.filter(req => {
                const user = findUserInCache(req.userId);
                return !searchTerm ||
                       (user && (user.email || '').toLowerCase().includes(searchTerm)) ||
                       (req.reference || '').toLowerCase().includes(searchTerm);
            });

            document.getElementById('noManualTopUpsPlaceholder').style.display = filteredRequests.length === 0 ? 'block' : 'none';
            if (filteredRequests.length === 0) return;

            filteredRequests.forEach(req => {
                const user = findUserInCache(req.userId);
                const requestedDate = req.createdAt?.toDate();
                const fullDate = requestedDate ? requestedDate.toLocaleString('en-GB') : 'No date available';

                tbody.innerHTML += `
                    <tr>
                        <td title="${fullDate}">${timeSince(requestedDate)}</td>
                        <td>${user?.email || 'N/A'}</td>
                        <td>${formatCurrency(req.amount)}</td>
                        <td>${req.reference}</td>
                        <td><span class="status-badge ${req.status}">${req.status}</span></td>
                        <td>
                            ${req.status === 'pending' ? `
                                <button class="action-btn approve-btn" data-txid="${req.id}" data-userid="${req.userId}" data-amount="${req.amount}">Approve</button>
                                <button class="action-btn reject-btn" data-txid="${req.id}">Reject</button>
                            ` : 'Processed'}
                        </td>
                    </tr>`;
            });
        };

        document.getElementById('manualTopUpSearch').addEventListener('input', loadManualTopUps);
        document.getElementById('manualTopUpStatusFilter').addEventListener('change', loadManualTopUps);

        document.getElementById('manualTopUpsTableBody').addEventListener('click', async (e) => {
            const button = e.target.closest('.action-btn');
            if (!button) return;
            const txId = button.dataset.txid;

            if (button.classList.contains('approve-btn')) {
                const userId = button.dataset.userid;
                const amount = parseFloat(button.dataset.amount);
                const { isConfirmed } = await Swal.fire({
                    title: "Approve Top-Up?",
                    html: `This will add <strong>${formatCurrency(amount)}</strong> to the user's wallet.`,
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonText: "Yes, approve it!"
                });
                if (isConfirmed) {
                    showAdminLoader();
                    try {
                        const batch = writeBatch(db);
                        batch.update(doc(db, "manualTopups", txId), {
                            status: "completed",
                            approvedAt: serverTimestamp(),
                            approvedBy: auth.currentUser?.uid || 'admin'
                        });
                        batch.update(doc(db, "users", userId), { balance: increment(amount) });

                        // Record transaction
                        const transactionRef = doc(collection(db, "transactions"));
                        batch.set(transactionRef, {
                            userId: userId,
                            type: 'credit',
                            amount: amount,
                            method: 'Manual Top-up',
                            status: 'completed',
                            reference: `Manual-${Date.now()}`,
                            createdAt: serverTimestamp()
                        });

                        await batch.commit();

                        const userIndex = allUsersCache.findIndex(u => u.id === userId);
                        if (userIndex > -1) allUsersCache[userIndex].balance += amount;

                        showToast("Top-up approved!", 'success');
                        await loadManualTopUps();
                    } catch (error) {
                        showToast("Approval failed", 'error', error.message);
                    } finally { hideAdminLoader(); }
                }
            } else if (button.classList.contains('reject-btn')) {
                 const { isConfirmed } = await Swal.fire({
                     title: "Reject Top-Up?",
                     text: "This request will be marked as rejected.",
                     icon: "warning",
                     showCancelButton: true,
                     confirmButtonColor: "#e74c3c",
                     confirmButtonText: "Yes, reject it!"
                    });
                if (isConfirmed) {
                    showAdminLoader();
                     try {
                        await updateDoc(doc(db, "manualTopups", txId), {
                            status: "rejected",
                            rejectedAt: serverTimestamp(),
                            rejectedBy: auth.currentUser?.uid || 'admin'
                        });
                        showToast("Top-up rejected!", 'info');
                        await loadManualTopUps();
                     } catch (error) {
                        showToast("Rejection failed", 'error', error.message);
                     } finally { hideAdminLoader(); }
                }
            }
        });
        */

        // ===================================================================================
        // AFA REGISTRATIONS MANAGEMENT
        // ===================================================================================
        const loadAfaRegistrations = async () => {
             const snapshot = await getDocs(query(collection(db, "afaRegistrations"), orderBy("createdAt", "desc")));
             let afas = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
             const tbody = document.getElementById('adminAfaRegTableBody');
             tbody.innerHTML = '';

             const searchTerm = document.getElementById('adminAfaSearch').value.toLowerCase();
             const statusFilter = document.getElementById('adminAfaStatusFilter').value;

             const filteredAfas = afas.filter(afa => {
                const statusMatch = statusFilter === 'all' || afa.status.toLowerCase() === statusFilter;
                const searchMatch = !searchTerm || (afa.afaFullName || afa.fullName || '').toLowerCase().includes(searchTerm) || (afa.phone || afa.phoneNumber || '').toLowerCase().includes(searchTerm);
                return statusMatch && searchMatch;
             });

             document.getElementById('noAdminAfaRegPlaceholder').style.display = filteredAfas.length === 0 ? 'block' : 'none';
             filteredAfas.forEach(afa => {
                const user = findUserInCache(afa.userId);
                tbody.innerHTML += `
                    <tr>
                        <td>${formatDate(afa.createdAt)}</td>
                        <td>${user?.email || 'N/A'}</td>
                        <td>${afa.afaFullName || afa.fullName || 'N/A'}</td>
                        <td>${afa.phone || afa.phoneNumber || 'N/A'}</td>
                        <td>${afa.afaGhanaCard || afa.ghanaCard || 'N/A'}</td>
                        <td><span class="status-badge ${afa.status.toLowerCase()}">${afa.status}</span></td>
                        <td><button class="action-btn view-btn" data-afaid="${afa.id}">View/Update</button></td>
                    </tr>`;
             });
        };
        document.getElementById('adminAfaSearch').addEventListener('input', loadAfaRegistrations);
        document.getElementById('adminAfaStatusFilter').addEventListener('change', loadAfaRegistrations);

        document.getElementById('adminAfaRegTableBody').addEventListener('click', async (e) => {
            if (e.target.closest('.view-btn')) {
                currentEditingAfaId = e.target.closest('.view-btn').dataset.afaid;
                const afaDoc = await getDoc(doc(db, "afaRegistrations", currentEditingAfaId));
                if (afaDoc.exists()) {
                    const afa = afaDoc.data();
                    document.getElementById('afaDetailsContent').innerHTML = `
                        <div class="info-readonly-group"><strong>Full Name:</strong><p>${afa.fullName || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Phone:</strong><p>${afa.phoneNumber || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Ghana Card:</strong><p>${afa.ghanaCard || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Occupation:</strong><p>${afa.occupation || 'N/A'}</p></div>
                        <div class="info-readonly-group"><strong>Date of Birth:</strong><p>${afa.dob || 'N/A'}</p></div>`;
                    document.getElementById('afaUpdateStatusSelect').value = afa.status;
                    openModal('afaDetailsModal');
                }
            }
        });

        document.getElementById('confirmUpdateAfaStatusBtn').addEventListener('click', async () => {
            if (!currentEditingAfaId) return;
            const button = document.getElementById('confirmUpdateAfaStatusBtn');
            toggleButtonLoading(button, true);
            try {
                await updateDoc(doc(db, "afaRegistrations", currentEditingAfaId), { status: document.getElementById('afaUpdateStatusSelect').value });
                showToast('AFA Status Updated!', 'success');
                closeModal('afaDetailsModal');
                await loadAfaRegistrations();
            } catch (error) {
                showToast('Update failed.', 'error');
            } finally {
                toggleButtonLoading(button, false);
                currentEditingAfaId = null;
            }
        });
        
        // ===================================================================================
        // MARKETPLACE MANAGEMENT (Simplified)
        // ===================================================================================
        // NOTE: These are simplified placeholders. You'll need to implement the full CRUD logic
        // for Banners, Categories, Products, and Website Queue if they are to be functional.
        // The modal HTML is provided for you to integrate.

        const loadMarketplaceBanners = async () => { 
            document.getElementById('noMarketplaceBannersPlaceholder').style.display = 'block'; 
            document.getElementById('marketplaceBannersTableBody').innerHTML = ''; 
            // Example of how you would load real data:
            // const q = query(collection(db, "marketplace_banners"), orderBy("order"));
            // const snapshot = await getDocs(q);
            // ... then populate table
        };
        document.getElementById('addNewBannerBtn').addEventListener('click', () => { /* ... openModal('bannerModal') ... */ showToast('Coming soon!', 'info'); });

        const loadMarketplaceCategories = async () => { 
            document.getElementById('noMarketplaceCategoriesPlaceholder').style.display = 'block'; 
            document.getElementById('marketplaceCategoriesTableBody').innerHTML = ''; 
            // Example of how you would load real data:
            // const q = query(collection(db, "marketplace_categories"), orderBy("order"));
            // const snapshot = await getDocs(q);
            // ... then populate table
        };
        document.getElementById('addNewCategoryBtn').addEventListener('click', () => { /* ... openModal('categoryModal') ... */ showToast('Coming soon!', 'info'); });

        const loadMarketplaceProducts = async () => { 
            document.getElementById('noMarketplaceProductsPlaceholder').style.display = 'block'; 
            document.getElementById('marketplaceProductsTableBody').innerHTML = ''; 
            // Example of how you would load real data:
            // const q = query(collection(db, "marketplace_products"), orderBy("name"));
            // const snapshot = await getDocs(q);
            // ... then populate table
        };
        document.getElementById('addNewProductBtn').addEventListener('click', () => { /* ... openModal('productModal') ... */ showToast('Coming soon!', 'info'); });
        
        const loadWebsiteQueue = async () => { 
            document.getElementById('noWebsiteQueuePlaceholder').style.display = 'block'; 
            document.getElementById('websiteQueueTableBody').innerHTML = ''; 
            // Example of how you would load real data:
            // const q = query(collection(db, "website_queue"), orderBy("createdAt", "desc"));
            // const snapshot = await getDocs(q);
            // ... then populate table
        };

        // ===================================================================================
        // NOTIFICATIONS MANAGEMENT
        // ===================================================================================
        const loadNotifications = async () => {
            const q = query(collection(db, "sent_notifications"), orderBy("createdAt", "desc"), limit(20)); // Assuming a new collection for sent notifications
            const snapshot = await getDocs(q);
            const tbody = document.getElementById('sentNotificationsTableBody');
            tbody.innerHTML = '';
            document.getElementById('noSentNotificationsPlaceholder').style.display = snapshot.empty ? 'block' : 'none';

            snapshot.forEach(doc => {
                const notif = { id: doc.id, ...doc.data() };
                // For target, you'd retrieve the actual user email if userId is not 'all'
                const target = notif.userId === 'all' ? 'All Users' : (findUserInCache(notif.userId)?.email || 'Specific User');
                tbody.innerHTML += `
                    <tr>
                        <td>${notif.title}</td>
                        <td>${notif.text.substring(0, 50)}${notif.text.length > 50 ? '...' : ''}</td>
                        <td>${target}</td>
                        <td>${formatDate(notif.createdAt)}</td>
                        <td>
                            <button class="action-btn delete-btn" data-notifid="${notif.id}">Delete</button>
                        </td>
                    </tr>
                `;
            });
        };

        document.getElementById('notificationTarget').addEventListener('change', (e) => {
            document.getElementById('specificUserField').style.display = e.target.value === 'specific' ? 'block' : 'none';
        });

        document.getElementById('sendNotificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = document.getElementById('sendNotificationBtn');
            toggleButtonLoading(button, true);
            
            const title = document.getElementById('notificationTitle').value;
            const text = document.getElementById('notificationText').value;
            const type = document.getElementById('notificationType').value;
            const targetOption = document.getElementById('notificationTarget').value;
            const userEmail = document.getElementById('notificationUserEmail').value.toLowerCase();

            const notificationsBatch = writeBatch(db);
            const sentNotificationRef = doc(collection(db, "sent_notifications")); // To keep a record in the admin panel
            
            try {
                if (targetOption === 'all') {
                    // Send to all users
                    for (const user of allUsersCache) {
                        const userNotifRef = doc(collection(db, "users", user.id, "notifications"));
                        notificationsBatch.set(userNotifRef, {
                            title, text, type, isRead: false, createdAt: serverTimestamp()
                        });
                    }
                    notificationsBatch.set(sentNotificationRef, { title, text, type, userId: 'all', createdAt: serverTimestamp() });

                } else if (targetOption === 'specific') {
                    const targetUser = allUsersCache.find(u => u.email.toLowerCase() === userEmail);
                    if (!targetUser) throw new Error("User with that email was not found.");
                    
                    const userNotifRef = doc(collection(db, "users", targetUser.id, "notifications"));
                    notificationsBatch.set(userNotifRef, {
                        title, text, type, isRead: false, createdAt: serverTimestamp()
                    });
                    notificationsBatch.set(sentNotificationRef, { title, text, type, userId: targetUser.id, createdAt: serverTimestamp() });
                }

                await notificationsBatch.commit();
                showToast(`Notification sent successfully!`, 'success');
                e.target.reset();
                bannerButtonFields.style.display = 'none'; // Hide button fields after sending
                await loadNotifications();
            } catch (error) {
                showToast('Failed to send notification', 'error', error.message);
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        document.getElementById('sentNotificationsTableBody').addEventListener('click', async (e) => {
             const target = e.target.closest('.delete-btn');
             if(target) {
                // Implementing this delete is complex as it involves deleting from all user subcollections.
                // A simpler approach for the admin panel is to just delete the record from 'sent_notifications'
                // and optionally provide a warning that it won't remove notifications already delivered to users.
                const notifId = target.dataset.notifid;
                const { isConfirmed } = await Swal.fire({
                    title: "Delete this notification record?",
                    text: "This will remove the notification from the admin history. It will NOT remove it from users who have already received it.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#e74c3c",
                    confirmButtonText: "Yes, delete record!"
                });
                if (isConfirmed) {
                    showAdminLoader();
                    try {
                        await deleteDoc(doc(db, "sent_notifications", notifId));
                        showToast('Notification record deleted!', 'success');
                        await loadNotifications();
                    } catch (error) {
                        showToast('Failed to delete record', 'error', error.message);
                    } finally {
                        hideAdminLoader();
                    }
                }
             }
        });
        
        // ===================================================================================
        // SITE CONTROLS & API MANAGEMENT [UPDATED]
        // ===================================================================================
        
        async function fetchApiWalletBalance() {
            if (!currentApiToken || !currentApiToken.startsWith('Bearer')) {
                apiBalanceValueEl.textContent = 'Token Invalid';
                return;
            }
            apiBalanceValueEl.textContent = 'Loading...';
            apiBalanceValueEl.classList.add('loading');
            refreshBalanceBtn.classList.add('loading');
            try {
                const response = await fetch("https://api.datafyhub.com/api/v1/walletBalance", {
                    method: 'GET',
                    headers: { 'Authorization': currentApiToken }
                });
                const result = await response.json();
                if (response.ok && result.message === "Wallet balance retrieved successfully") {
                    const balance = parseFloat(result.data?.balance || 0).toFixed(2);
                    apiBalanceValueEl.textContent = `GHS ${balance}`;
                } else {
                    throw new Error(result.message || 'Failed to fetch balance. Check token.');
                }
            } catch (error) {
                console.error('API Balance Fetch Error:', error);
                apiBalanceValueEl.textContent = 'Error';
                Swal.fire('API Error', `Could not fetch balance: ${error.message}`, 'error');
            } finally {
                apiBalanceValueEl.classList.remove('loading');
                refreshBalanceBtn.classList.remove('loading');
            }
        }

        async function updateApiSetting(updateData) {
            try {
                await setDoc(doc(db, 'config', 'integrations'), updateData, { merge: true });
                showToast('API Setting updated!', 'success');
            } catch (error) {
                showToast('Save Failed', 'error');
            }
        }
        
        refreshBalanceBtn.addEventListener('click', fetchApiWalletBalance);
        processingModeToggle.addEventListener('change', () => {
            const newMode = processingModeToggle.checked ? 'auto' : 'manual';
            updateApiSetting({ processingMode: newMode });
        });
        saveTokenBtn.addEventListener('click', async () => {
            let newToken = bearerTokenInput.value.trim();
            if (!newToken) return showToast('Token cannot be empty.', 'warning');
            if (!newToken.startsWith('Bearer ')) newToken = `Bearer ${newToken}`;
            toggleButtonLoading(saveTokenBtn, true);
            await updateApiSetting({ datafyHubApiKey: newToken });
            bearerTokenInput.value = '';
            await loadSiteSettings(); // Re-load settings to update UI
            toggleButtonLoading(saveTokenBtn, false);
        });

        const loadSiteSettings = async () => {
            // Load from unified siteSettings/config (priority for user-facing settings)
            const unifiedSettingsRef = doc(db, 'siteSettings', 'config');
            const unifiedSnap = await getDoc(unifiedSettingsRef);

            // Also load from legacy collections for compatibility
            const settingsDocRef = doc(db, 'settings', 'global');
            const keysDocRef = doc(db, 'config', 'keys');
            const servicesConfigRef = doc(db, 'config', 'services_config');
            const bannerConfigRef = doc(db, 'config', 'dashboardNotification');
            const paymentMethodsConfigRef = doc(db, 'config', 'payment_methods');
            const integrationsConfigRef = doc(db, 'config', 'integrations');
            const storeControlsRef = doc(db, 'config', 'storeControls');

            const [settingsSnap, keysSnap, servicesSnap, bannerSnap, paymentSnap, integrationsSnap, storeControlsSnap] = await Promise.all([
                getDoc(settingsDocRef), getDoc(keysDocRef), getDoc(servicesConfigRef), getDoc(bannerConfigRef), getDoc(paymentMethodsConfigRef), getDoc(integrationsConfigRef), getDoc(storeControlsRef)
            ]);

            // If unified settings exist, prioritize them for user-facing toggles
            if (unifiedSnap.exists()) {
                const unified = unifiedSnap.data();

                // Maintenance & Access
                maintenanceModeToggle.checked = unified.maintenanceModeEnabled || false;
                maintenanceMessageInput.value = unified.maintenanceMessage || '';
                registrationDisabledToggle.checked = unified.registrationDisabled || false;
                registrationApprovalRequiredToggle.checked = unified.registrationApprovalRequired || false;

                // Payment
                if (unified.paystackPublicKey) paystackPublicKeyInput.value = unified.paystackPublicKey;
                if (unified.paystackSecretKey) paystackSecretKeyInput.value = unified.paystackSecretKey;
                instantTopUpToggle.checked = unified.instantTopUpEnabled !== false;
                // REMOVED: Manual top-up feature no longer used
                // manualTopUpToggle.checked = unified.manualTopUpEnabled !== false;

                // Provider config (direct processing)
                const providerTokenInputAdmin = document.getElementById('providerTokenInputAdmin');
                const providerUrlInputAdmin = document.getElementById('providerUrlInputAdmin');
                const providerDirectToggleAdmin = document.getElementById('providerDirectToggleAdmin');
                const providerConfigStatusAdmin = document.getElementById('providerConfigStatusAdmin');
                if (providerTokenInputAdmin) providerTokenInputAdmin.value = unified.externalProviderApiKey || unified.datafyApiToken || '';
                if (providerUrlInputAdmin) providerUrlInputAdmin.value = unified.externalProviderUrl || 'https://api.datafyhub.com/api/v1/placeOrder';
                if (providerDirectToggleAdmin) providerDirectToggleAdmin.checked = !!unified.directOrderProcessingEnabled;
                if (providerConfigStatusAdmin) providerConfigStatusAdmin.textContent = 'Status: Loaded';

                // Save handler for provider config
                const saveProviderConfigBtnAdmin = document.getElementById('saveProviderConfigBtnAdmin');
                if (saveProviderConfigBtnAdmin && !saveProviderConfigBtnAdmin.__hooked) {
                    saveProviderConfigBtnAdmin.__hooked = true;
                    saveProviderConfigBtnAdmin.addEventListener('click', async () => {
                        const token = providerTokenInputAdmin ? providerTokenInputAdmin.value.trim() : '';
                        const url = providerUrlInputAdmin ? providerUrlInputAdmin.value.trim() : '';
                        const enabled = providerDirectToggleAdmin ? !!providerDirectToggleAdmin.checked : false;
                        toggleButtonLoading(saveProviderConfigBtnAdmin, true);
                        try {
                            await setDoc(doc(db, 'siteSettings', 'config'), {
                                externalProviderApiKey: token || '',
                                externalProviderUrl: url || 'https://api.datafyhub.com/api/v1/placeOrder',
                                directOrderProcessingEnabled: enabled
                            }, { merge: true });
                            if (providerConfigStatusAdmin) providerConfigStatusAdmin.textContent = 'Status: Saved';
                            showToast('Success', 'Provider configuration saved', 'success');
                        } catch (err) {
                            console.error('Failed to save provider config:', err);
                            if (providerConfigStatusAdmin) providerConfigStatusAdmin.textContent = 'Status: Save failed';
                            showToast('Error', 'Failed to save provider configuration', 'error');
                        } finally {
                            toggleButtonLoading(saveProviderConfigBtnAdmin, false);
                        }
                    });
                }

                // Services
                afaRegistrationToggle.checked = unified.afaRegistrationEnabled !== false;
                afaMinsToggle.checked = unified.afaMinsEnabled !== false;

                // Store controls
                closeAllStoresToggle.checked = unified.closeAllStores || false;
                disableSundayPurchasesToggle.checked = unified.disableSundayPurchases || false;

                // Banner
                bannerIsActiveToggle.checked = unified.siteNotificationActive || false;
                bannerImageUrlInput.value = unified.bannerImageUrl || '';
                bannerTitleInput.value = unified.siteNotificationTitle || '';
                bannerDescriptionInput.value = unified.bannerDescription || unified.siteNotificationMessage || '';
                bannerIsButtonActiveToggle.checked = unified.bannerIsButtonActive || false;
                bannerButtonTextInput.value = unified.bannerButtonText || '';
                bannerButtonLinkInput.value = unified.bannerButtonLink || '';
                bannerButtonFields.style.display = unified.bannerIsButtonActive ? 'block' : 'none';

                // Pricing
                goldenTicketPriceInput.value = unified.goldenTicketPrice || '';

                // API
                if (unified.bearerToken) currentApiToken = unified.bearerToken;
                processingModeToggle.checked = unified.processingModeEnabled || false;
            }

            // --- API & Integration ---
            if (integrationsSnap.exists()) {
                const settings = integrationsSnap.data();
                currentApiToken = settings.datafyHubApiKey;
                processingModeToggle.checked = settings.processingMode === 'auto';
                bearerTokenInput.placeholder = currentApiToken ? 'Token is set. Enter new to update.' : 'No token set.';
                await fetchApiWalletBalance();
            } else {
                apiBalanceValueEl.textContent = 'Config Missing';
                processingModeToggle.checked = false;
                bearerTokenInput.placeholder = 'No token set.';
            }

            // --- Payment Method Controls ---
            if (paymentSnap.exists()) {
                const p = paymentSnap.data();
                instantTopUpToggle.checked = p.isInstantTopUpEnabled !== false;
                // REMOVED: Manual top-up feature no longer used
                // manualTopUpToggle.checked = p.isManualTopUpEnabled !== false;
            } else {
                instantTopUpToggle.checked = true;
                // REMOVED: Manual top-up feature no longer used
                // manualTopUpToggle.checked = true;
            }
            if (keysSnap.exists()) {
                const k = keysSnap.data();
                paystackPublicKeyInput.value = k.paystack_public_key || '';
                paystackSecretKeyInput.value = k.paystack_secret_key || ''; // Hidden field, but can be loaded
            } else {
                paystackPublicKeyInput.value = '';
                paystackSecretKeyInput.value = '';
            }

            // --- Global Store Controls ---
            if (storeControlsSnap.exists()) {
                const controls = storeControlsSnap.data();
                storePaystackPublicKeyInput.value = controls.storePaystackPublicKey || '';
                closeAllStoresToggle.checked = controls.closeAllStore || false;
                disableSundayPurchasesToggle.checked = controls.disableSundayPurchases || false;
            } else {
                storePaystackPublicKeyInput.value = '';
                closeAllStoresToggle.checked = false;
                disableSundayPurchasesToggle.checked = false;
            }

            // --- General Settings ---
            if (settingsSnap.exists()) {
                const s = settingsSnap.data();
                goldenTicketPriceInput.value = s.goldenTicketPrice || '';
                maintenanceModeToggle.checked = s.maintenanceMode || false;
                maintenanceMessageInput.value = s.maintenanceMessage || '';
                registrationDisabledToggle.checked = s.registrationDisabled || false;
                registrationApprovalRequiredToggle.checked = s.registrationApprovalRequired || false;
            } else {
                goldenTicketPriceInput.value = '';
                maintenanceModeToggle.checked = false;
                maintenanceMessageInput.value = '';
                registrationDisabledToggle.checked = false;
                registrationApprovalRequiredToggle.checked = false;
            }

            // --- Service Availability ---
            if (servicesSnap.exists()) {
                const sv = servicesSnap.data();
                afaRegistrationToggle.checked = sv.isAfaRegistrationAvailable !== false;
                afaMinsToggle.checked = sv.isAfaMinsAvailable !== false;
            } else {
                afaRegistrationToggle.checked = true;
                afaMinsToggle.checked = true;
            }

            // --- Dashboard Notification Banner ---
            if (bannerSnap.exists()) {
                const b = bannerSnap.data();
                bannerIsActiveToggle.checked = b.isActive || false;
                bannerImageUrlInput.value = b.bannerUrl || '';
                bannerTitleInput.value = b.title || '';
                bannerDescriptionInput.value = b.description || '';
                bannerIsButtonActiveToggle.checked = b.isButtonActive || false;
                bannerButtonTextInput.value = b.buttonText || '';
                bannerButtonLinkInput.value = b.buttonLink || '';
                bannerButtonFields.style.display = b.isButtonActive ? 'block' : 'none';
            } else {
                bannerIsActiveToggle.checked = false;
                bannerImageUrlInput.value = '';
                bannerTitleInput.value = '';
                bannerDescriptionInput.value = '';
                bannerIsButtonActiveToggle.checked = false;
                bannerButtonTextInput.value = '';
                bannerButtonLinkInput.value = '';
                bannerButtonFields.style.display = 'none';
            }
        };

        bannerIsButtonActiveToggle.addEventListener('change', e => {
            bannerButtonFields.style.display = e.target.checked ? 'block' : 'none';
        });

        document.getElementById('siteSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = document.getElementById('saveSiteSettingsBtn');
            toggleButtonLoading(button, true);

            const batch = writeBatch(db);
            
            // --- API & Integrations ---
            batch.set(doc(db, 'config', 'integrations'), {
                datafyHubApiKey: currentApiToken, // Ensure current token is saved, not just input field
                processingMode: processingModeToggle.checked ? 'auto' : 'manual'
            }, { merge: true });

            // --- Payment Method Controls (config/payment_methods & config/keys) ---
            batch.set(doc(db, 'config', 'payment_methods'), {
                isInstantTopUpEnabled: instantTopUpToggle.checked,
                // REMOVED: Manual top-up feature no longer used
                // isManualTopUpEnabled: manualTopUpToggle.checked,
            }, { merge: true });
            batch.set(doc(db, 'config', 'keys'), {
                paystack_public_key: paystackPublicKeyInput.value.trim(),
                paystack_secret_key: paystackSecretKeyInput.value.trim() // Ensure secret key is also saved
            }, { merge: true });


            // --- Global Store Controls (config/storeControls) ---
            batch.set(doc(db, 'config', 'storeControls'), {
                storePaystackPublicKey: storePaystackPublicKeyInput.value.trim(),
                closeAllStore: closeAllStoresToggle.checked,
                disableSundayPurchases: disableSundayPurchasesToggle.checked,
                // Add maintenanceMode and message here as they affect public store too
                isMaintenanceModeEnabled: maintenanceModeToggle.checked, // Global maintenance mode
                maintenanceMessage: maintenanceMessageInput.value.trim()
            }, { merge: true });

            // --- General Settings (settings/global) ---
            batch.set(doc(db, 'settings', 'global'), {
                goldenTicketPrice: parseFloat(goldenTicketPriceInput.value) || 0,
                // Maintenance mode moved to storeControls for broader impact
                registrationDisabled: registrationDisabledToggle.checked,
                registrationApprovalRequired: registrationApprovalRequiredToggle.checked
            }, { merge: true });

            // --- Service Availability (config/services_config) ---
            batch.set(doc(db, 'config', 'services_config'), {
                isAfaRegistrationAvailable: afaRegistrationToggle.checked,
                isAfaMinsAvailable: afaMinsToggle.checked
            }, { merge: true });

            // --- Dashboard Notification Banner (config/dashboardNotification) ---
            batch.set(doc(db, 'config', 'dashboardNotification'), {
                isActive: bannerIsActiveToggle.checked,
                bannerUrl: bannerImageUrlInput.value.trim(),
                title: bannerTitleInput.value.trim(),
                description: bannerDescriptionInput.value.trim(),
                isButtonActive: bannerIsButtonActiveToggle.checked,
                buttonText: bannerButtonTextInput.value.trim(),
                buttonLink: bannerButtonLinkInput.value.trim()
            }, { merge: true });

            // --- UNIFIED SETTINGS: Save to siteSettings/config for main site (auth.html, index.html) ---
            batch.set(doc(db, 'siteSettings', 'config'), {
                // Maintenance & Access Control
                maintenanceModeEnabled: maintenanceModeToggle.checked,
                maintenanceMessage: maintenanceMessageInput.value.trim(),
                registrationDisabled: registrationDisabledToggle.checked,
                registrationApprovalRequired: registrationApprovalRequiredToggle.checked,

                // Payment Configuration
                paystackPublicKey: paystackPublicKeyInput.value.trim(),
                paystackSecretKey: paystackSecretKeyInput.value.trim(),
                instantTopUpEnabled: instantTopUpToggle.checked,
                // REMOVED: Manual top-up feature no longer used
                // manualTopUpEnabled: manualTopUpToggle.checked,

                // SMS Integration (if fields exist)
                // bulkSmsApiKey: bulkSmsApiKeyInput.value.trim(),
                // bulkSmsSenderId: bulkSmsSenderIdInput.value.trim(),

                // Service Pricing
                afaFee: 5.00, // Default AFA fee
                goldenTicketPrice: parseFloat(goldenTicketPriceInput.value) || 0,

                // API Integration
                bearerToken: currentApiToken,
                processingModeEnabled: processingModeToggle.checked,

                // Store Controls
                closeAllStores: closeAllStoresToggle.checked,
                disableSundayPurchases: disableSundayPurchasesToggle.checked,

                // Service Availability
                afaRegistrationEnabled: afaRegistrationToggle.checked,
                afaMinsEnabled: afaMinsToggle.checked,

                // Dashboard Notification Banner
                siteNotificationActive: bannerIsActiveToggle.checked,
                siteNotificationTitle: bannerTitleInput.value.trim(),
                siteNotificationMessage: bannerDescriptionInput.value.trim(),
                bannerImageUrl: bannerImageUrlInput.value.trim(),
                bannerDescription: bannerDescriptionInput.value.trim(),
                bannerIsButtonActive: bannerIsButtonActiveToggle.checked,
                bannerButtonText: bannerButtonTextInput.value.trim(),
                bannerButtonLink: bannerButtonLinkInput.value.trim()
            }, { merge: true });

            try {
                await batch.commit();
                showToast('All settings saved successfully!', 'success');
            } catch (error) {
                showToast('Failed to save settings: ' + error.message, 'error');
            } finally {
                toggleButtonLoading(button, false);
            }
        });
        
        const handleStoreBanBySlug = async (shouldBan) => {
            const slug = storeSlugToBan.value.trim().toLowerCase();
            if (!slug) {
                showToast("Please enter a store slug.", 'warning');
                return;
            }

            showAdminLoader();
            try {
                const storeQuery = query(collection(db, "stores"), where("slug", "==", slug), limit(1));
                const snapshot = await getDocs(storeQuery);

                if (snapshot.empty) {
                    showToast('Store not found', 'error', `No store found with slug: ${slug}`);
                    return;
                }

                const storeDoc = snapshot.docs[0];
                await updateDoc(storeDoc.ref, { isBanned: shouldBan });
                showToast(`Store "${slug}" has been ${shouldBan ? 'banned' : 'unbanned'}!`, 'success');
                storeSlugToBan.value = ''; // Clear input
                await loadStores(); // Refresh stores table
            } catch (error) {
                console.error("Error banning/unbanning store:", error);
                showToast('Operation Failed', 'error', error.message);
            } finally {
                hideAdminLoader();
            }
        };

        banStoreBtn.addEventListener('click', () => handleStoreBanBySlug(true));
        unbanStoreBtn.addEventListener('click', () => handleStoreBanBySlug(false));
    </script>
</body>
</html>
